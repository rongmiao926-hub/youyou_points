<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif; }
    body { margin:0; padding:0; background:#f3f4f6; color:#111827; }
    .container { max-width: 1100px; margin: 24px auto; padding: 16px; }
    h1 { font-size: 24px; margin-bottom: 8px; }
    .subtitle { color:#6b7280; margin-bottom: 24px; font-size: 14px; }
    .section { background:#fff; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px; box-shadow: 0 8px 16px rgba(15,23,42,0.04); }
    .section h2 { font-size: 18px; margin: 0 0 10px; display:flex; align-items:center; gap:8px; }
    .section h2 span.badge { font-size: 12px; background:#eef2ff; color:#4f46e5; padding:2px 8px; border-radius: 999px; }
    .section-desc { font-size: 13px; color:#6b7280; margin-bottom: 12px; }

    form.inline-form { display:flex; flex-wrap: wrap; gap:8px; margin-bottom: 10px; align-items:center; }
    input[type="text"], input[type="number"], select {
      padding: 6px 8px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 13px; min-width: 0;
    }
    input[type="number"] { width: 110px; }
    input:focus, select:focus { outline: none; border-color:#4f46e5; box-shadow: 0 0 0 1px rgba(79,70,229,0.2); }

    button {
      border-radius: 999px; border:none; padding: 6px 14px; font-size: 13px; cursor:pointer;
      display:inline-flex; align-items:center; gap:4px; white-space: nowrap;
    }
    button.primary { background:#4f46e5; color:#fff; }
    button.secondary { background:#e5e7eb; color:#374151; }
    button.danger { background:#fee2e2; color:#b91c1c; }
    button:disabled { opacity: .6; cursor: default; }

    table { width:100%; border-collapse: collapse; font-size: 13px; margin-top: 6px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 6px 4px; text-align: left; vertical-align: middle; }
    th { font-weight: 600; color:#4b5563; background: #f9fafb; }
    tr:last-child td { border-bottom: none; }

    .empty-tip { font-size: 12px; color:#9ca3af; padding: 4px 0; }
    .tag { display:inline-block; font-size: 11px; padding: 2px 6px; border-radius: 999px; background:#f3f4f6; color:#4b5563; }

    .calc-columns { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 16px; }
    @media (max-width: 768px) { .calc-columns { grid-template-columns: 1fr; } }

    .calc-section-title { display:flex; justify-content: space-between; align-items:center; margin-bottom: 4px; }
    .result-box { margin-top: 12px; padding: 10px 12px; border-radius: 10px; background:#f9fafb; border: 1px solid #e5e7eb; font-size: 13px; display:grid; gap: 4px; }
    .result-row { display:flex; justify-content: space-between; gap: 12px; }
    .result-label { color:#6b7280; }
    .result-value { font-weight: 600; }
    .result-balance.positive { color:#16a34a; }
    .result-balance.negative { color:#b91c1c; }

    .footer-tip { margin-top: 8px; font-size: 11px; color:#9ca3af; }

    .inline-check { display:flex; align-items:center; gap:6px; font-size: 13px; color:#374151; }
    .inline-check input { width: 16px; height: 16px; }

    .pill {
      display:inline-flex; align-items:center; gap:8px;
      background:#f9fafb; border:1px solid #e5e7eb; padding: 8px 10px; border-radius: 12px;
      flex-wrap: wrap;
    }

    .mini {
      font-size: 12px;
      color:#6b7280;
    }

    .scenario-grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .scenario-row {
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .scenario-cond-list {
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .scenario-cond-list .inline-check {
      background:#f9fafb;
      border:1px solid #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
    }

    .scenario-table-wrap {
      overflow:auto;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background:#fff;
    }

    .btn-row {
      display:flex; gap:8px; flex-wrap: wrap; align-items:center;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">
  <h1>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</h1>
  <div class="subtitle">
    å…ˆé…ç½®ã€Œæ€ä¹ˆèµšåˆ†ã€ã€Œæ€ä¹ˆèŠ±åˆ†ã€ã€Œé‚€è¯·ç³»ç»Ÿã€ï¼Œå†ç”¨æ¨¡æ‹Ÿå™¨è¯•ç®—ï¼›ä¹Ÿå¯ä»¥ç”¨ã€Œæƒ…æ™¯åˆ†æã€ä¸€é”®ç”Ÿæˆä¸åŒé‚€è¯·äººæ•°ä¸‹çš„å¯å…‘æ¢ç»“æœã€‚
  </div>

  <!-- 1. èµšç§¯åˆ†å…¥å£ -->
  <section class="section" id="earn-section">
    <h2>
      1. èµšç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¥æºé…ç½®</span>
    </h2>

    <!-- è§„åˆ™ç®¡ç†æŒ‰é’®ï¼šæ”¾åœ¨èµšç§¯åˆ†æ¨¡å—å‰é¢ -->
    <div class="pill" style="margin-bottom: 12px;">
      <div class="btn-row">
        <button id="saveConfigButton" class="secondary">ğŸ’¾ ä¿å­˜å½“å‰ç§¯åˆ†è§„åˆ™</button>
        <button id="loadConfigButton" class="secondary">ğŸ“‚ è½½å…¥å·²ä¿å­˜è§„åˆ™</button>
        <button id="clearConfigButton" class="secondary">ğŸ§¹ æ¸…é™¤æœ¬åœ°ä¿å­˜</button>
        <button id="exportXlsxButton" class="secondary">ğŸ“‘ å¯¼å‡ºè§„åˆ™ä¸º Excel</button>
        <button id="importXlsxButton" class="secondary">ğŸ“¥ å¯¼å…¥è§„åˆ™ï¼ˆExcelï¼‰</button>
        <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" style="display:none;" />
      </div>
      <div class="mini">æç¤ºï¼šExcel å¯¼å‡º/å¯¼å…¥åŒ…å« 3 ä¸ª Sheetï¼šEarnRules / SpendRules / InviteRulesã€‚</div>
    </div>

    <div class="section-desc">
      æ¯æ¡é€”å¾„å¯æ ‡è®°ã€Œæ˜¯å¦ä¸€æ¬¡æ€§å¥–åŠ±ã€ã€‚ä¸€æ¬¡æ€§å¥–åŠ±åœ¨æ¨¡æ‹ŸåŒºç”¨å‹¾é€‰è¡¨ç¤ºâ€œå®Œæˆä¸€æ¬¡â€ï¼›éä¸€æ¬¡æ€§å¥–åŠ±åœ¨æ¨¡æ‹ŸåŒºå¡«å†™æ¬¡æ•°ã€‚
    </div>

    <form class="inline-form" id="addEarnForm">
      <input type="text" id="earnName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šæ³¨å†ŒæˆåŠŸï¼‰" required />
      <input type="number" id="earnPoints" placeholder="æ¯æ¬¡è·å¾—ç§¯åˆ†" min="0" step="1" required />
      <label class="inline-check" title="ä¸€æ¬¡æ€§å¥–åŠ±åœ¨æ¨¡æ‹ŸåŒºç”¨å‹¾é€‰è¡¨ç¤ºå®Œæˆä¸€æ¬¡">
        <input type="checkbox" id="earnOnce" />
        æ˜¯å¦ä¸€æ¬¡æ€§å¥–åŠ±
      </label>
      <button type="submit" class="primary">+ æ·»åŠ èµšç§¯åˆ†é€”å¾„</button>
    </form>

    <div id="earnListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 40%;">é€”å¾„åç§°</th>
          <th style="width: 20%;">æ¯æ¬¡è·å¾—ç§¯åˆ†</th>
          <th style="width: 20%;">ä¸€æ¬¡æ€§å¥–åŠ±</th>
          <th style="width: 20%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="earnTableBody"></tbody>
      </table>
      <div id="earnEmptyTip" class="empty-tip">è¿˜æ²¡æœ‰é…ç½®èµšç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚</div>
    </div>
  </section>

  <!-- 2. èŠ±ç§¯åˆ†å…¥å£ -->
  <section class="section" id="spend-section">
    <h2>
      2. èŠ±ç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¶ˆè€—é…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå…‘æ¢ä¼šå‘˜ -xxx åˆ†ã€‚å°†ç”¨äºæ¨¡æ‹Ÿä¸æƒ…æ™¯åˆ†æçš„â€œæŒ‰ä¼˜å…ˆçº§æœ€å¤šå¯å…‘æ¢â€ã€‚
    </div>
    <form class="inline-form" id="addSpendForm">
      <input type="text" id="spendName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šå…‘æ¢1å¤©ä¼šå‘˜ï¼‰" required />
      <input type="number" id="spendPoints" placeholder="æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">+ æ·»åŠ èŠ±ç§¯åˆ†é€”å¾„</button>
    </form>

    <div id="spendListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 55%;">é€”å¾„åç§°</th>
          <th style="width: 25%;">æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†</th>
          <th style="width: 20%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="spendTableBody"></tbody>
      </table>
      <div id="spendEmptyTip" class="empty-tip">è¿˜æ²¡æœ‰é…ç½®èŠ±ç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚</div>
    </div>
  </section>

  <!-- 3. é‚€è¯·ç³»ç»Ÿé…ç½® -->
  <section class="section" id="invite-section">
    <h2>
      3. é‚€è¯·ç³»ç»Ÿï¼ˆé˜¶æ¢¯å¥–åŠ±ï¼‰
      <span class="badge">æŒ‰é‚€è¯·äººæ•°åŒºé—´è®¾ç½®å¥–åŠ±</span>
    </h2>
    <div class="section-desc">
      æ¯æ¡è§„åˆ™å½¢å¦‚ï¼šé‚€è¯·ã€minã€‘è‡³ã€maxã€‘ä¸ªç”¨æˆ·ï¼Œè¢«é‚€è¯·äººã€Œæ¡ä»¶ã€ï¼Œå¾—ã€ç§¯åˆ†ã€‘ç§¯åˆ† / äººã€‚<br>
      è®¡ç®—æŒ‰åŒºé—´æ‹†æ®µç´¯åŠ ï¼ˆåŒä¸€æ¡ä»¶å¯é…ç½®å¤šä¸ªåŒºé—´ï¼‰ã€‚
    </div>
    <form class="inline-form" id="addInviteRuleForm">
      <input type="text" id="inviteCondition" placeholder="è¢«é‚€è¯·äººæ¡ä»¶ï¼ˆå¦‚ï¼šè¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸï¼‰" required />
      <input type="number" id="inviteMin" placeholder="èµ·å§‹äººæ•°ï¼ˆminï¼‰" min="0" step="1" required />
      <input type="number" id="inviteMax" placeholder="ç»“æŸäººæ•°ï¼ˆmaxï¼‰" min="0" step="1" required />
      <input type="number" id="invitePoints" placeholder="æ¯äººç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">+ æ·»åŠ é‚€è¯·è§„åˆ™</button>
    </form>

    <div id="inviteRuleListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 40%;">è¢«é‚€è¯·äººæ¡ä»¶</th>
          <th style="width: 30%;">é‚€è¯·äººæ•°åŒºé—´</th>
          <th style="width: 20%;">æ¯äººç§¯åˆ†</th>
          <th style="width: 10%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="inviteRuleTableBody"></tbody>
      </table>
      <div id="inviteRuleEmptyTip" class="empty-tip">è¿˜æ²¡æœ‰é…ç½®é‚€è¯·è§„åˆ™ã€‚</div>
    </div>
  </section>

  <!-- 4. æƒ…æ™¯åˆ†æ -->
  <section class="section" id="scenario-section">
    <h2>
      4. æƒ…æ™¯åˆ†æï¼ˆæ‰¹é‡è¾“å‡ºï¼‰
      <span class="badge">Nâ†’M é‚€è¯·äººæ•°æšä¸¾</span>
    </h2>
    <div class="section-desc">
      ä½ å¯ä»¥è®¾ç½®ï¼šç”¨æˆ·å®Œæˆäº†å“ªäº›èµšç§¯åˆ†é€”å¾„ï¼ˆä¸€æ¬¡æ€§å‹¾é€‰/éä¸€æ¬¡æ€§æ¬¡æ•°ï¼‰ï¼Œå¹¶é€‰æ‹©å¤šä¸ªè¢«é‚€è¯·äººæ¡ä»¶ï¼›
      ç„¶åå¯¹é‚€è¯·äººæ•°ä»ã€èµ·å§‹ã€‘åˆ°ã€ç»“æŸã€‘é€ä¸€è¾“å‡ºï¼šå¯å…‘æ¢å¥–åŠ± + è·ç¦»ä¸‹ä¸€æ¡£ä½ã€‚
    </div>

    <div class="scenario-grid">
      <div>
        <div class="calc-section-title">
          <strong>å®Œæˆå“ªäº›èµšç§¯åˆ†é€”å¾„</strong>
          <span class="tag">ä¸€æ¬¡æ€§=å‹¾é€‰ï¼›éä¸€æ¬¡æ€§=æ¬¡æ•°</span>
        </div>

        <div class="pill" style="margin: 8px 0;">
          <label class="inline-check">
            <input type="checkbox" id="scenarioAllOnceDone" />
            å®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±
          </label>
          <span class="mini">å‹¾ä¸Šåï¼šæƒ…æ™¯åˆ†æä¸­çš„ä¸€æ¬¡æ€§é€”å¾„å°†å…¨éƒ¨è§†ä¸ºå®Œæˆä¸€æ¬¡ã€‚</span>
        </div>

        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡ç§¯åˆ†</th>
            <th style="width: 140px;">å®Œæˆ/æ¬¡æ•°</th>
          </tr>
          </thead>
          <tbody id="scenarioEarnBody"></tbody>
        </table>
        <div id="scenarioEarnEmptyTip" class="empty-tip">æš‚æ— èµšç§¯åˆ†é…ç½®ã€‚</div>
      </div>

      <div>
        <div class="calc-section-title">
          <strong>é‚€è¯·ç³»ç»Ÿ</strong>
          <span class="tag">æ¡ä»¶é€‰æ‹©ä¸äººæ•°èŒƒå›´</span>
        </div>

        <div class="scenario-row">
          <strong>é‚€è¯·äººæ•°èŒƒå›´ï¼š</strong>
          <input type="number" id="scenarioInviteFrom" min="0" step="1" value="0" />
          <span>åˆ°</span>
          <input type="number" id="scenarioInviteTo" min="0" step="1" value="10" />
          <span class="mini">ï¼ˆå°†è¾“å‡ºæ¯ä¸€ä¸ªäººæ•°ï¼šfrom, from+1, ... , toï¼‰</span>
        </div>

        <div class="scenario-row">
          <strong>è¢«é‚€è¯·äººæ¡ä»¶ï¼š</strong>
          <div id="scenarioCondList" class="scenario-cond-list"></div>
        </div>
        <div class="mini">å¯å¤šé€‰æ¡ä»¶ï¼Œè¡¨ç¤ºæ¯ä¸ªæ¡ä»¶éƒ½å„è‡ªæŒ‰ Nâ†’M è®¡ç®—é‚€è¯·ç§¯åˆ†å¹¶ç´¯åŠ ã€‚</div>
      </div>

      <div class="btn-row">
        <button id="scenarioRunBtn" class="primary">ğŸ§¾ ç”Ÿæˆè¡¨æ ¼</button>
        <button id="scenarioCopyBtn" class="secondary" disabled>ğŸ“‹ å¤åˆ¶è¡¨æ ¼ï¼ˆTSVï¼‰</button>
        <button id="scenarioExportBtn" class="secondary" disabled>ğŸ“‘ å¯¼å‡ºä¸º Excel</button>
      </div>

      <div class="scenario-table-wrap">
        <table id="scenarioTable">
          <thead>
          <tr>
            <th style="min-width: 340px;">å®Œæˆæ¡ä»¶</th>
            <th style="min-width: 260px;">å¯å…‘æ¢å¥–åŠ±</th>
            <th style="min-width: 260px;">è·ç¦»ä¸‹ä¸€æ¡£ä½</th>
          </tr>
          </thead>
          <tbody id="scenarioTbody">
          <tr><td class="empty-tip" colspan="3">å°šæœªç”Ÿæˆã€‚ç‚¹å‡»â€œç”Ÿæˆè¡¨æ ¼â€ã€‚</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- 5. æ¨¡æ‹Ÿè®¡ç®— -->
  <section class="section" id="calc-section">
    <h2>
      5. ç§¯åˆ†æ¨¡æ‹Ÿè®¡ç®—
      <span class="badge">æ¬¡æ•°/å‹¾é€‰ â†’ å‰©ä½™ç§¯åˆ†</span>
    </h2>
    <div class="section-desc">
      ä¸€æ¬¡æ€§å¥–åŠ±ï¼šå‹¾é€‰è¡¨ç¤ºå®Œæˆä¸€æ¬¡ï¼›éä¸€æ¬¡æ€§å¥–åŠ±ï¼šå¡«å†™æ¬¡æ•°ã€‚<br>
      ä½ ä¹Ÿå¯ä»¥å‹¾é€‰ã€Œå®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±ã€ä¸€é”®ç®—ä¸Šæ‰€æœ‰ä¸€æ¬¡æ€§åˆ†æ•°ã€‚
    </div>

    <div class="pill" style="margin-bottom: 10px;">
      <label class="inline-check">
        <input type="checkbox" id="allOnceDoneCheckbox" />
        æ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±å·²å®Œæˆ
      </label>
      <span class="mini">å‹¾ä¸Šåï¼šæ¨¡æ‹ŸåŒºé‡Œæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±ä¼šè‡ªåŠ¨å‹¾é€‰å¹¶é”å®šã€‚</span>
    </div>

    <div class="calc-columns">
      <!-- å·¦ä¾§ï¼šèµšç§¯åˆ† + é‚€è¯·ç³»ç»Ÿ -->
      <div>
        <div class="calc-section-title">
          <strong>èµšç§¯åˆ†ï¼ˆä¸€æ¬¡æ€§=å‹¾é€‰ï¼›éä¸€æ¬¡æ€§=æ¬¡æ•°ï¼‰</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¥æºåˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>
        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡ç§¯åˆ†</th>
            <th style="width: 120px;">å®Œæˆ/æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="earnCalcBody"></tbody>
        </table>
        <div id="earnCalcEmptyTip" class="empty-tip">æš‚æ— èµšç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€Œèµšç§¯åˆ†çš„é€”å¾„ã€ã€‚</div>

        <div style="margin-top: 16px;">
          <div class="calc-section-title">
            <strong>é‚€è¯·ç³»ç»Ÿç§¯åˆ†</strong>
            <span class="tag">æ ¹æ®é˜¶æ¢¯è§„åˆ™è‡ªåŠ¨è®¡ç®—</span>
          </div>
          <table>
            <thead>
            <tr>
              <th>è¢«é‚€è¯·äººæ¡ä»¶</th>
              <th style="width: 120px;">é‚€è¯·äººæ•°</th>
              <th>å°è®¡ç§¯åˆ†</th>
            </tr>
            </thead>
            <tbody id="inviteCalcBody"></tbody>
          </table>
          <div id="inviteCalcEmptyTip" class="empty-tip">å½“å‰å°šæœªä¸ºä»»æ„æ¡ä»¶é…ç½®é‚€è¯·è§„åˆ™ã€‚</div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šèŠ±ç§¯åˆ† -->
      <div>
        <div class="calc-section-title">
          <strong>èŠ±ç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¶ˆè€—åˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>
        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡èŠ±è´¹</th>
            <th style="width: 120px;">ä½¿ç”¨æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="spendCalcBody"></tbody>
        </table>
        <div id="spendCalcEmptyTip" class="empty-tip">æš‚æ— èŠ±ç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€ŒèŠ±ç§¯åˆ†çš„é€”å¾„ã€ã€‚</div>
      </div>
    </div>

    <div style="margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="calcButton" class="primary">ğŸ’° è®¡ç®—ç§¯åˆ†</button>
      <button id="resetCountsButton" class="secondary">æ¸…ç©ºæ‰€æœ‰æ¬¡æ•°/å‹¾é€‰</button>
    </div>

    <div class="result-box">
      <div class="result-row">
        <span class="result-label">æ€»å…±è·å¾—ç§¯åˆ†ï¼ˆå«é‚€è¯·ï¼‰ï¼š</span>
        <span class="result-value" id="totalEarned">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">æ€»å…±èŠ±è´¹ç§¯åˆ†ï¼š</span>
        <span class="result-value" id="totalSpent">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">å‰©ä½™ç§¯åˆ†ï¼š</span>
        <span class="result-value result-balance" id="balance">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">æŒ‰ä¼˜å…ˆçº§æœ€å¤šå¯å…‘æ¢ï¼š</span>
        <span class="result-value" id="redeemSuggestion">â€”</span>
      </div>
    </div>

    <div class="footer-tip">
      å»ºè®®ï¼šå…ˆå¯¼å‡ºä¸€ç‰ˆ Excel ä½œä¸ºã€Œç§¯åˆ†ç­–ç•¥ v1ã€ï¼Œè°ƒæ•´åå¦å­˜ä¸º v2/v3ï¼Œæ–¹ä¾¿å¯¹æ¯”ã€‚
    </div>
  </section>

</div>

<script>
  // ====== å¸¸é‡ ======
  const STORAGE_KEY = "points-config-final-v1";

  // å…‘æ¢ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰
  const REDEEM_PRIORITY = [
    "å…‘æ¢1å¹´ä¼šå‘˜",
    "å…‘æ¢6ä¸ªæœˆä¼šå‘˜",
    "å…‘æ¢3ä¸ªæœˆä¼šå‘˜",
    "å…‘æ¢1ä¸ªæœˆä¼šå‘˜",
    "å…‘æ¢1å‘¨ä¼šå‘˜",
    "å…‘æ¢3å¤©ä¼šå‘˜",
    "å…‘æ¢1å¤©ä¼šå‘˜"
  ];

  // ====== å…¨å±€æ•°æ® ======
  // earnActions: {id, name, points, once:boolean}
  // spendActions: {id, name, points}
  // inviteRules: {id, condition, min, max, points}
  let earnActions = [];
  let spendActions = [];
  let inviteRules = [];
  let nextId = 1;

  // ====== DOM å¼•ç”¨ ======
  const earnTableBody = document.getElementById("earnTableBody");
  const spendTableBody = document.getElementById("spendTableBody");
  const inviteRuleTableBody = document.getElementById("inviteRuleTableBody");

  const earnEmptyTip = document.getElementById("earnEmptyTip");
  const spendEmptyTip = document.getElementById("spendEmptyTip");
  const inviteRuleEmptyTip = document.getElementById("inviteRuleEmptyTip");

  const earnCalcBody = document.getElementById("earnCalcBody");
  const spendCalcBody = document.getElementById("spendCalcBody");
  const inviteCalcBody = document.getElementById("inviteCalcBody");

  const earnCalcEmptyTip = document.getElementById("earnCalcEmptyTip");
  const spendCalcEmptyTip = document.getElementById("spendCalcEmptyTip");
  const inviteCalcEmptyTip = document.getElementById("inviteCalcEmptyTip");

  const totalEarnedSpan = document.getElementById("totalEarned");
  const totalSpentSpan = document.getElementById("totalSpent");
  const balanceSpan = document.getElementById("balance");
  const redeemSuggestionSpan = document.getElementById("redeemSuggestion");

  const allOnceDoneCheckbox = document.getElementById("allOnceDoneCheckbox");

  // æƒ…æ™¯åˆ†æ DOM
  const scenarioAllOnceDone = document.getElementById("scenarioAllOnceDone");
  const scenarioEarnBody = document.getElementById("scenarioEarnBody");
  const scenarioEarnEmptyTip = document.getElementById("scenarioEarnEmptyTip");
  const scenarioInviteFrom = document.getElementById("scenarioInviteFrom");
  const scenarioInviteTo = document.getElementById("scenarioInviteTo");

  const scenarioCondList = document.getElementById("scenarioCondList");

  const scenarioRunBtn = document.getElementById("scenarioRunBtn");
  const scenarioCopyBtn = document.getElementById("scenarioCopyBtn");
  const scenarioExportBtn = document.getElementById("scenarioExportBtn");
  const scenarioTbody = document.getElementById("scenarioTbody");

  let scenarioLastRows = [];    // for copy/export

  // ====== å·¥å…· ======
  function recomputeNextId() {
    const all = [...earnActions, ...spendActions, ...inviteRules];
    nextId = all.length === 0 ? 1 : (Math.max(...all.map(x => x.id || 0)) + 1);
  }

  function clampNonNegInt(v) {
    const n = Number(v);
    if (!Number.isFinite(n) || n < 0) return 0;
    return Math.floor(n);
  }

  function toBoolOnce(v) {
    const s = String(v ?? "").trim().toLowerCase();
    if (s === "æ˜¯" || s === "yes" || s === "true" || s === "1") return true;
    if (s === "å¦" || s === "no" || s === "false" || s === "0") return false;
    return false;
  }

  function getByAliases(row, aliases) {
    const keys = Object.keys(row || {});
    for (const a of aliases) {
      const hit = keys.find(k => String(k).trim() === a);
      if (hit !== undefined) return row[hit];
    }
    return undefined;
  }

  function toNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function uniq(arr) {
    return [...new Set(arr)];
  }

  // ====== æ¸²æŸ“ï¼šèµšç§¯åˆ†åˆ—è¡¨ ======
  function renderEarnActions() {
    earnTableBody.innerHTML = "";
    earnEmptyTip.style.display = earnActions.length ? "none" : "block";

    earnActions.forEach(action => {
      const tr = document.createElement("tr");

      // åç§°
      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      // ç§¯åˆ†å¯ç¼–è¾‘
      const pointsTd = document.createElement("td");
      const pInput = document.createElement("input");
      pInput.type = "number";
      pInput.min = "0";
      pInput.step = "1";
      pInput.value = action.points;
      pInput.style.width = "90px";
      pInput.addEventListener("change", () => {
        action.points = clampNonNegInt(pInput.value);
        pInput.value = action.points;
        renderCalcTables();
        renderScenarioEarn();
      });
      pointsTd.appendChild(pInput);
      const pSpan = document.createElement("span");
      pSpan.textContent = " åˆ†";
      pSpan.style.marginLeft = "4px";
      pointsTd.appendChild(pSpan);
      tr.appendChild(pointsTd);

      // ä¸€æ¬¡æ€§å¯ç¼–è¾‘
      const onceTd = document.createElement("td");
      const onceLabel = document.createElement("label");
      onceLabel.className = "inline-check";
      const onceInput = document.createElement("input");
      onceInput.type = "checkbox";
      onceInput.checked = !!action.once;
      onceInput.addEventListener("change", () => {
        action.once = onceInput.checked;
        renderCalcTables();
        renderScenarioEarn();
      });
      onceLabel.appendChild(onceInput);
      const onceTxt = document.createElement("span");
      onceTxt.textContent = "æ˜¯";
      onceLabel.appendChild(onceTxt);
      onceTd.appendChild(onceLabel);
      tr.appendChild(onceTd);

      // åˆ é™¤
      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        earnActions = earnActions.filter(a => a.id !== action.id);
        renderEarnActions();
        renderCalcTables();
        renderScenarioEarn();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      earnTableBody.appendChild(tr);
    });
  }

  // ====== æ¸²æŸ“ï¼šèŠ±ç§¯åˆ†åˆ—è¡¨ ======
  function renderSpendActions() {
    spendTableBody.innerHTML = "";
    spendEmptyTip.style.display = spendActions.length ? "none" : "block";

    spendActions.forEach(action => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      const pointsTd = document.createElement("td");
      const pInput = document.createElement("input");
      pInput.type = "number";
      pInput.min = "0";
      pInput.step = "1";
      pInput.value = action.points;
      pInput.style.width = "90px";
      pInput.addEventListener("change", () => {
        action.points = clampNonNegInt(pInput.value);
        pInput.value = action.points;
        // ä¸å¼ºåˆ¶é‡æ¸²æŸ“æ¨¡æ‹Ÿè¡¨ï¼ˆä½†å»ºè®®ï¼‰
        renderCalcTables();
      });
      pointsTd.appendChild(pInput);
      const pSpan = document.createElement("span");
      pSpan.textContent = " åˆ†";
      pSpan.style.marginLeft = "4px";
      pointsTd.appendChild(pSpan);
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        spendActions = spendActions.filter(a => a.id !== action.id);
        renderSpendActions();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      spendTableBody.appendChild(tr);
    });
  }

  // ====== æ¸²æŸ“ï¼šé‚€è¯·è§„åˆ™åˆ—è¡¨ ======
  function renderInviteRules() {
    inviteRuleTableBody.innerHTML = "";
    inviteRuleEmptyTip.style.display = inviteRules.length ? "none" : "block";

    const sorted = [...inviteRules].sort((a, b) => {
      const ac = (a.condition || "").trim();
      const bc = (b.condition || "").trim();
      if (ac === bc) return (a.min - b.min) || (a.max - b.max);
      return ac.localeCompare(bc, "zh-CN");
    });

    sorted.forEach(rule => {
      const tr = document.createElement("tr");

      const condTd = document.createElement("td");
      condTd.textContent = rule.condition;
      tr.appendChild(condTd);

      const rangeTd = document.createElement("td");
      rangeTd.textContent = `${rule.min} ï½ ${rule.max} äºº`;
      tr.appendChild(rangeTd);

      const pointsTd = document.createElement("td");
      pointsTd.textContent = `${rule.points} åˆ†/äºº`;
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ ";
      delBtn.className = "danger";
      delBtn.style.padding = "4px 8px";
      delBtn.addEventListener("click", () => {
        inviteRules = inviteRules.filter(r => r.id !== rule.id);
        renderInviteRules();
        renderCalcTables();
        renderScenarioCondCheckboxes();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      inviteRuleTableBody.appendChild(tr);
    });

    renderScenarioCondCheckboxes();
  }

  // ====== é‚€è¯·ç§¯åˆ†è®¡ç®—ï¼ˆæŸæ¡ä»¶ï¼‰ ======
  function calcInvitePointsForCondition(condition, totalInvites) {
    const rules = inviteRules.filter(r => (r.condition || "").trim() === (condition || "").trim());
    if (!rules.length || totalInvites <= 0) return 0;

    const sorted = [...rules].sort((a,b) => a.min - b.min || a.max - b.max);
    let total = 0;

    sorted.forEach(rule => {
      // æŒ‰ä½ çš„åŸé€»è¾‘ï¼šä» 1 å¼€å§‹è®¡æ•°ï¼ˆä½†ä½ çš„è§„åˆ™é‡Œ min æœ‰ 0ï¼Œ0-1 å®é™…åªç®— 1 äººï¼‰
      const start = Math.max(rule.min, 1);
      if (totalInvites < start) return;
      const end = Math.min(rule.max, totalInvites);
      if (end < start) return;
      const count = end - start + 1;
      total += count * rule.points;
    });

    return total;
  }

  // ====== å…‘æ¢æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§æœ€å¤§å¯å…‘æ¢ï¼‰ ======
  function getSpendByName(name) {
    return spendActions.find(a => a.name === name);
  }

  function redeemPlan(balance) {
    const plan = [];
    let remaining = balance;

    for (const name of REDEEM_PRIORITY) {
      const action = getSpendByName(name);
      if (!action || !action.points || action.points <= 0) continue;
      const cnt = Math.floor(remaining / action.points);
      if (cnt > 0) {
        const displayName = name.replace(/^å…‘æ¢/, "");
        plan.push({ name: displayName, count: cnt, cost: cnt * action.points, unit: action.points });
        remaining -= cnt * action.points;
      }
    }

    return { plan, remaining };
  }

  function planToText(plan) {
    if (!plan || plan.length === 0) return "å½“å‰ç§¯åˆ†ä¸è¶³ä»¥å…‘æ¢ä»»ä½•ä¼šå‘˜æ¡£ä½ã€‚";
    return plan.map(x => x.count === 1 ? x.name : `${x.name}*${x.count}`).join(" + ");
  }

  function nextTierDistance(remaining) {
    // ç”±äº redeemPlan æ˜¯ä»é«˜åˆ°ä½è´ªå¿ƒï¼Œæœ€å remaining ä¸€å®š < æœ€å°æ¡£ä½ä»·æ ¼ï¼ˆå¦‚æœæœ€å°æ¡£ä½å­˜åœ¨ï¼‰
    const candidates = REDEEM_PRIORITY
      .map(n => getSpendByName(n))
      .filter(x => x && x.points > 0);

    if (!candidates.length) return "æœªé…ç½®ä»»ä½•å…‘æ¢æ¡£ä½ã€‚";

    const cheapest = candidates.reduce((a,b) => a.points <= b.points ? a : b);
    if (remaining >= cheapest.points) {
      // ç†è®ºä¸Šä¸ä¼šå‘ç”Ÿï¼Œä½†å…œåº•
      return `å½“å‰å‰©ä½™ç§¯åˆ†å·²å¯å†å…‘æ¢ï¼š${cheapest.name.replace(/^å…‘æ¢/,"")}`;
    }
    const need = cheapest.points - remaining;
    return `è¿˜å·® ${need} åˆ†å¯ä»¥å†å…‘æ¢ ${cheapest.name.replace(/^å…‘æ¢/,"")}`;
  }

  // ====== æ¸²æŸ“æ¨¡æ‹ŸåŒºè¡¨æ ¼ ======
  function renderCalcTables() {
    // èµšç§¯åˆ†æ¨¡æ‹Ÿï¼ˆä¸€æ¬¡æ€§=å‹¾é€‰ï¼›éä¸€æ¬¡æ€§=æ¬¡æ•°ï¼‰
    earnCalcBody.innerHTML = "";
    if (!earnActions.length) {
      earnCalcEmptyTip.style.display = "block";
    } else {
      earnCalcEmptyTip.style.display = "none";
      earnActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name + (action.once ? "ï¼ˆä¸€æ¬¡æ€§ï¼‰" : "");
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points;
        tr.appendChild(pointsTd);

        const inputTd = document.createElement("td");
        if (action.once) {
          const label = document.createElement("label");
          label.className = "inline-check";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "earn-once-checkbox";
          cb.dataset.actionId = action.id;
          cb.checked = false;
          label.appendChild(cb);
          const t = document.createElement("span");
          t.textContent = "å®Œæˆ";
          label.appendChild(t);
          inputTd.appendChild(label);
        } else {
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0";
          input.step = "1";
          input.value = "0";
          input.className = "earn-count-input";
          input.dataset.actionId = action.id;
          input.style.width = "90px";
          inputTd.appendChild(input);
        }
        tr.appendChild(inputTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.className = "earn-subtotal";
        subtotalTd.dataset.actionId = action.id;
        tr.appendChild(subtotalTd);

        earnCalcBody.appendChild(tr);
      });
    }

    // èŠ±ç§¯åˆ†æ¨¡æ‹Ÿï¼ˆæ¬¡æ•°ï¼‰
    spendCalcBody.innerHTML = "";
    if (!spendActions.length) {
      spendCalcEmptyTip.style.display = "block";
    } else {
      spendCalcEmptyTip.style.display = "none";
      spendActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points;
        tr.appendChild(pointsTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.className = "spend-count-input";
        input.dataset.actionId = action.id;
        input.style.width = "90px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.className = "spend-subtotal";
        subtotalTd.dataset.actionId = action.id;
        tr.appendChild(subtotalTd);

        spendCalcBody.appendChild(tr);
      });
    }

    // é‚€è¯·ç³»ç»Ÿæ¨¡æ‹Ÿ
    inviteCalcBody.innerHTML = "";
    const conditions = uniq(inviteRules.map(r => (r.condition || "").trim()).filter(Boolean));
    if (!conditions.length) {
      inviteCalcEmptyTip.style.display = "block";
    } else {
      inviteCalcEmptyTip.style.display = "none";
      conditions.forEach(cond => {
        const tr = document.createElement("tr");

        const condTd = document.createElement("td");
        condTd.textContent = cond;
        tr.appendChild(condTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.className = "invite-count-input";
        input.dataset.condition = cond;
        input.style.width = "90px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.className = "invite-subtotal";
        subtotalTd.dataset.condition = cond;
        tr.appendChild(subtotalTd);

        inviteCalcBody.appendChild(tr);
      });
    }

    // åº”ç”¨â€œä¸€æ¬¡æ€§å…¨å®Œæˆâ€çš„é”å®šé€»è¾‘
    applyAllOnceDoneToCalc();
  }

  function applyAllOnceDoneToCalc() {
    const on = allOnceDoneCheckbox.checked;
    document.querySelectorAll(".earn-once-checkbox").forEach(cb => {
      if (on) {
        cb.checked = true;
        cb.disabled = true;
      } else {
        cb.disabled = false;
      }
    });
  }

  // ====== è®¡ç®—ç§¯åˆ†ï¼ˆæ¨¡æ‹ŸåŒºï¼‰ ======
  function calculatePoints() {
    let totalEarned = 0;
    let totalSpent = 0;

    // èµšç§¯åˆ†ï¼šä¸€æ¬¡æ€§å‹¾é€‰ç®— 1 æ¬¡ï¼›éä¸€æ¬¡æ€§ç®— count
    earnActions.forEach(action => {
      let subtotal = 0;
      if (action.once) {
        const cb = document.querySelector('.earn-once-checkbox[data-action-id="' + action.id + '"]');
        const done = cb ? cb.checked : false;
        subtotal = done ? action.points : 0;
      } else {
        const input = document.querySelector('.earn-count-input[data-action-id="' + action.id + '"]');
        const count = input ? clampNonNegInt(input.value) : 0;
        subtotal = count * action.points;
      }
      totalEarned += subtotal;
      const td = document.querySelector('.earn-subtotal[data-action-id="' + action.id + '"]');
      if (td) td.textContent = subtotal;
    });

    // èŠ±ç§¯åˆ†ï¼šæ¬¡æ•°
    spendActions.forEach(action => {
      const input = document.querySelector('.spend-count-input[data-action-id="' + action.id + '"]');
      const count = input ? clampNonNegInt(input.value) : 0;
      const subtotal = count * action.points;
      totalSpent += subtotal;
      const td = document.querySelector('.spend-subtotal[data-action-id="' + action.id + '"]');
      if (td) td.textContent = subtotal;
    });

    // é‚€è¯·ï¼šæ¯ä¸ªæ¡ä»¶è¾“å…¥ä¸€ä¸ªäººæ•°
    document.querySelectorAll(".invite-count-input").forEach(input => {
      const cond = input.dataset.condition;
      const count = clampNonNegInt(input.value);
      const subtotal = calcInvitePointsForCondition(cond, count);
      totalEarned += subtotal;

      const td = document.querySelector('.invite-subtotal[data-condition="' + cond + '"]');
      if (td) td.textContent = subtotal;
    });

    const balance = totalEarned - totalSpent;

    totalEarnedSpan.textContent = totalEarned;
    totalSpentSpan.textContent = totalSpent;
    balanceSpan.textContent = balance;
    balanceSpan.classList.remove("positive", "negative");
    if (balance > 0) balanceSpan.classList.add("positive");
    else if (balance < 0) balanceSpan.classList.add("negative");

    const { plan } = redeemPlan(balance);
    redeemSuggestionSpan.textContent = planToText(plan);
  }

  function resetAllCounts() {
    // earn
    document.querySelectorAll(".earn-count-input").forEach(i => i.value = "0");
    document.querySelectorAll(".earn-once-checkbox").forEach(cb => {
      cb.checked = false;
      cb.disabled = false;
    });
    allOnceDoneCheckbox.checked = false;

    // spend + invite
    document.querySelectorAll(".spend-count-input, .invite-count-input").forEach(i => i.value = "0");
    document.querySelectorAll(".earn-subtotal, .spend-subtotal, .invite-subtotal").forEach(td => td.textContent = "0");

    totalEarnedSpan.textContent = "0";
    totalSpentSpan.textContent = "0";
    balanceSpan.textContent = "0";
    balanceSpan.classList.remove("positive", "negative");
    redeemSuggestionSpan.textContent = "â€”";
  }

  // ====== æœ¬åœ°ä¿å­˜ / è½½å…¥ ======
  function saveConfig() {
    const data = { earnActions, spendActions, inviteRules };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert("å·²ä¿å­˜åˆ°æœ¬æµè§ˆå™¨ï¼ˆåŒä¸€å°è®¾å¤‡ã€åŒä¸€æµè§ˆå™¨ä¸‹ä¼šä¿ç•™ï¼‰");
    } catch (e) {
      console.error(e);
      alert("ä¿å­˜å¤±è´¥ï¼šå¯èƒ½æ˜¯æµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨ã€‚");
    }
  }

  function loadConfig(showAlert = true) {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      if (showAlert) alert("æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return false;
    }
    try {
      const data = JSON.parse(raw);
      earnActions = Array.isArray(data.earnActions) ? data.earnActions : [];
      spendActions = Array.isArray(data.spendActions) ? data.spendActions : [];
      inviteRules = Array.isArray(data.inviteRules) ? data.inviteRules : [];
      // å…¼å®¹æ—§æ•°æ®ï¼šç¼º once åˆ™é»˜è®¤ä¸º false
      earnActions = earnActions.map(a => ({ ...a, once: !!a.once }));
      recomputeNextId();

      renderEarnActions();
      renderSpendActions();
      renderInviteRules();
      renderCalcTables();
      renderScenarioEarn();
      resetAllCounts();

      if (showAlert) alert("å·²è½½å…¥æœ¬åœ°ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return true;
    } catch (e) {
      console.error(e);
      if (showAlert) alert("ä¿å­˜çš„æ•°æ®å·²æŸåï¼Œæ— æ³•è¯»å–ã€‚");
      return false;
    }
  }

  function clearConfig() {
    localStorage.removeItem(STORAGE_KEY);
    alert("å·²æ¸…é™¤æœ¬åœ°ä¿å­˜ã€‚å½“å‰é¡µé¢ä¸Šçš„è§„åˆ™ä¸ä¼šè‡ªåŠ¨æ¸…ç©ºï¼Œå¦‚éœ€é‡ç½®è¯·æ‰‹åŠ¨ä¿®æ”¹æˆ–å¯¼å…¥å…¶ä»–æ–¹æ¡ˆã€‚");
  }

  // ====== å¯¼å‡º Excelï¼ˆè§„åˆ™ï¼‰ ======
  function exportConfigToXlsx() {
    if (typeof XLSX === "undefined") {
      alert("å½“å‰ç¯å¢ƒæ— æ³•ä½¿ç”¨ Excel å¯¼å‡ºåŠŸèƒ½ã€‚");
      return;
    }

    const wb = XLSX.utils.book_new();

    // EarnRules
    const earnData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†", "æ˜¯å¦ä¸€æ¬¡æ€§å¥–åŠ±"]];
    earnActions.forEach(a => {
      earnData.push(["èµšç§¯åˆ†", a.name, a.points, a.once ? "æ˜¯" : "å¦"]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(earnData), "EarnRules");

    // SpendRules
    const spendData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†"]];
    spendActions.forEach(a => {
      spendData.push(["èŠ±ç§¯åˆ†", a.name, a.points]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(spendData), "SpendRules");

    // InviteRules
    const inviteData = [["è¢«é‚€è¯·äººæ¡ä»¶", "èµ·å§‹äººæ•°", "ç»“æŸäººæ•°", "æ¯äººç§¯åˆ†"]];
    inviteRules.forEach(r => {
      inviteData.push([r.condition, r.min, r.max, r.points]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(inviteData), "InviteRules");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    XLSX.writeFile(wb, `ç§¯åˆ†è§„åˆ™_${y}${m}${d}.xlsx`);
  }

  // ====== ä» Excel å¯¼å…¥ï¼ˆè§„åˆ™ï¼‰ ======
  function importConfigFromXlsx(file) {
    if (!file) return;
    const reader = new FileReader();

    reader.onload = function(e) {
      try {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: "array" });

        const earnSheet = workbook.Sheets["EarnRules"];
        const spendSheet = workbook.Sheets["SpendRules"];
        const inviteSheet = workbook.Sheets["InviteRules"];

        if (!earnSheet || !spendSheet) {
          alert("Excel æ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å« EarnRules å’Œ SpendRules ä¸¤ä¸ª Sheetã€‚");
          return;
        }

        const earnJson = XLSX.utils.sheet_to_json(earnSheet, { defval: "" });
        const spendJson = XLSX.utils.sheet_to_json(spendSheet, { defval: "" });

        earnActions = earnJson.map((row, idx) => ({
          id: idx + 1,
          name: String(getByAliases(row, ["é€”å¾„åç§°"]) ?? "").trim(),
          points: clampNonNegInt(getByAliases(row, ["æ¯æ¬¡ç§¯åˆ†", "æ¯æ¬¡åˆ†", "æ¯æ¬¡è·å¾—ç§¯åˆ†"])),
          once: toBoolOnce(getByAliases(row, ["æ˜¯å¦ä¸€æ¬¡æ€§å¥–åŠ±", "ä¸€æ¬¡æ€§å¥–åŠ±", "æ˜¯å¦ä¸€æ¬¡æ€§", "æ˜¯å¦ä¸ºä¸€æ¬¡æ€§å¥–åŠ±"]))
        })).filter(r => r.name);

        const base = earnActions.length + 1;

        spendActions = spendJson.map((row, idx) => ({
          id: base + idx,
          name: String(getByAliases(row, ["é€”å¾„åç§°"]) ?? "").trim(),
          points: clampNonNegInt(getByAliases(row, ["æ¯æ¬¡ç§¯åˆ†", "æ¯æ¬¡åˆ†", "æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†"]))
        })).filter(r => r.name);

        let inviteBase = base + spendActions.length;
        if (inviteSheet) {
          const inviteJson = XLSX.utils.sheet_to_json(inviteSheet, { defval: "" });
          inviteRules = inviteJson.map((row, idx) => ({
            id: inviteBase + idx,
            condition: String(getByAliases(row, ["è¢«é‚€è¯·äººæ¡ä»¶", "æ¡ä»¶"]) ?? "").trim(),
            min: clampNonNegInt(getByAliases(row, ["èµ·å§‹äººæ•°", "min"])),
            max: clampNonNegInt(getByAliases(row, ["ç»“æŸäººæ•°", "max"])),
            points: clampNonNegInt(getByAliases(row, ["æ¯äººç§¯åˆ†", "ç§¯åˆ†"]))
          })).filter(r => r.condition);
        } else {
          inviteRules = [];
        }

        recomputeNextId();
        renderEarnActions();
        renderSpendActions();
        renderInviteRules();
        renderCalcTables();
        renderScenarioEarn();
        resetAllCounts();

        alert("å·²æˆåŠŸä» Excel å¯¼å…¥è§„åˆ™ï¼");
      } catch (err) {
        console.error(err);
        alert("Excel æ–‡ä»¶è§£æå¤±è´¥ã€‚è¯·ç¡®è®¤ Sheet åä¸åˆ—åæ˜¯å¦æ­£ç¡®ã€‚");
      }
    };

    reader.readAsArrayBuffer(file);
  }

  // ====== æƒ…æ™¯åˆ†æï¼šæ¸²æŸ“â€œå®Œæˆå“ªäº›èµšç§¯åˆ†é€”å¾„â€ ======
  function renderScenarioEarn() {
    scenarioEarnBody.innerHTML = "";
    scenarioEarnEmptyTip.style.display = earnActions.length ? "none" : "block";

    if (!earnActions.length) return;

    earnActions.forEach(a => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = a.name + (a.once ? "ï¼ˆä¸€æ¬¡æ€§ï¼‰" : "");
      tr.appendChild(nameTd);

      const pTd = document.createElement("td");
      pTd.textContent = a.points;
      tr.appendChild(pTd);

      const inputTd = document.createElement("td");
      if (a.once) {
        const label = document.createElement("label");
        label.className = "inline-check";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "scenario-earn-once";
        cb.dataset.actionId = a.id;
        cb.checked = false;
        label.appendChild(cb);
        const t = document.createElement("span");
        t.textContent = "å®Œæˆ";
        label.appendChild(t);
        inputTd.appendChild(label);
      } else {
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.className = "scenario-earn-count";
        input.dataset.actionId = a.id;
        input.style.width = "90px";
        inputTd.appendChild(input);
      }
      tr.appendChild(inputTd);

      scenarioEarnBody.appendChild(tr);
    });

    applyScenarioAllOnceDone();
  }

  function applyScenarioAllOnceDone() {
    const on = scenarioAllOnceDone.checked;
    document.querySelectorAll(".scenario-earn-once").forEach(cb => {
      if (on) { cb.checked = true; cb.disabled = true; }
      else { cb.disabled = false; }
    });
  }

  // ====== æƒ…æ™¯åˆ†æï¼šæ¡ä»¶å¤šé€‰ ======
  function getScenarioSelectedConds() {
    return Array.from(document.querySelectorAll(".scenario-cond-checkbox:checked"))
      .map(cb => cb.value);
  }

  function renderScenarioCondCheckboxes() {
    const prev = new Set(getScenarioSelectedConds());
    const conds = uniq(inviteRules.map(r => (r.condition || "").trim()).filter(Boolean))
      .sort((a,b)=>a.localeCompare(b,"zh-CN"));

    scenarioCondList.innerHTML = "";
    if (!conds.length) {
      const tip = document.createElement("span");
      tip.className = "mini";
      tip.textContent = "æš‚æ— é‚€è¯·æ¡ä»¶";
      scenarioCondList.appendChild(tip);
      return;
    }

    conds.forEach(c => {
      const label = document.createElement("label");
      label.className = "inline-check";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "scenario-cond-checkbox";
      cb.value = c;
      cb.checked = prev.has(c);
      label.appendChild(cb);

      const text = document.createElement("span");
      text.textContent = c;
      label.appendChild(text);

      scenarioCondList.appendChild(label);
    });
  }

  // ====== æƒ…æ™¯åˆ†æï¼šè®¡ç®— earn ç§¯åˆ†ï¼ˆåŸºäºé€‰æ‹©ï¼‰ ======
  function calcScenarioEarnTotal() {
    let total = 0;

    earnActions.forEach(a => {
      if (a.once) {
        const cb = document.querySelector('.scenario-earn-once[data-action-id="' + a.id + '"]');
        const done = cb ? cb.checked : false;
        if (done) total += a.points;
      } else {
        const input = document.querySelector('.scenario-earn-count[data-action-id="' + a.id + '"]');
        const cnt = input ? clampNonNegInt(input.value) : 0;
        total += cnt * a.points;
      }
    });

    return total;
  }

  function buildScenarioConditionText(inviteN, selectedConds) {
    // â€œå®Œæˆæ¡ä»¶â€åˆ—ï¼šèµšç§¯åˆ†å®Œæˆæƒ…å†µ + é‚€è¯·è¯´æ˜
    const parts = [];

    if (scenarioAllOnceDone.checked) {
      parts.push("å®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±");
    } else {
      // åˆ—å‡ºå‹¾é€‰çš„ä¸€æ¬¡æ€§
      const doneOnceNames = earnActions
        .filter(a => a.once)
        .filter(a => {
          const cb = document.querySelector('.scenario-earn-once[data-action-id="' + a.id + '"]');
          return cb && cb.checked;
        })
        .map(a => a.name);

      if (doneOnceNames.length) parts.push("ä¸€æ¬¡æ€§ï¼š" + doneOnceNames.join("ã€"));
    }

    // åˆ—å‡ºéä¸€æ¬¡æ€§æ¬¡æ•°ï¼ˆ>0ï¼‰
    const repeatParts = earnActions
      .filter(a => !a.once)
      .map(a => {
        const input = document.querySelector('.scenario-earn-count[data-action-id="' + a.id + '"]');
        const cnt = input ? clampNonNegInt(input.value) : 0;
        return cnt > 0 ? `${a.name}Ã—${cnt}` : null;
      })
      .filter(Boolean);

    if (repeatParts.length) parts.push("éä¸€æ¬¡æ€§ï¼š" + repeatParts.join("ã€"));

    // é‚€è¯·æ¡ä»¶æè¿°
    const condText = selectedConds.length ? selectedConds.join(" + ") : "ï¼ˆæœªé€‰æ¡ä»¶ï¼‰";
    parts.push(`é‚€è¯·äººæ•°=${inviteN}ï¼›æ¡ä»¶ï¼š${condText}`);

    return parts.join("ï¼›");
  }

  // ====== æƒ…æ™¯åˆ†æï¼šç”Ÿæˆè¡¨æ ¼ ======
  function runScenario() {
    const from = clampNonNegInt(scenarioInviteFrom.value);
    const to = clampNonNegInt(scenarioInviteTo.value);
    if (to < from) {
      alert("é‚€è¯·äººæ•°èŒƒå›´ï¼šç»“æŸä¸èƒ½å°äºèµ·å§‹ã€‚");
      return;
    }
    const selectedConds = getScenarioSelectedConds();
    if (!selectedConds.length) {
      alert("è¯·è‡³å°‘é€‰æ‹© 1 ä¸ªè¢«é‚€è¯·äººæ¡ä»¶ã€‚");
      return;
    }

    const earnBase = calcScenarioEarnTotal();

    scenarioLastRows = [];
    scenarioTbody.innerHTML = "";

    for (let n = from; n <= to; n++) {
      let inviteTotal = 0;
      selectedConds.forEach(cond => {
        inviteTotal += calcInvitePointsForCondition(cond, n);
      });

      const totalEarn = earnBase + inviteTotal;
      const { plan, remaining } = redeemPlan(totalEarn);
      const redeemText = planToText(plan);
      const distanceText = nextTierDistance(remaining);

      const condText = buildScenarioConditionText(n, selectedConds);

      scenarioLastRows.push({
        "å®Œæˆæ¡ä»¶": condText,
        "å¯å…‘æ¢å¥–åŠ±": redeemText,
        "è·ç¦»ä¸‹ä¸€æ¡£ä½": distanceText
      });

      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = condText;
      const td2 = document.createElement("td"); td2.textContent = redeemText;
      const td3 = document.createElement("td"); td3.textContent = distanceText;
      tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
      scenarioTbody.appendChild(tr);
    }

    scenarioCopyBtn.disabled = scenarioLastRows.length === 0;
    scenarioExportBtn.disabled = scenarioLastRows.length === 0;
  }

  function copyScenarioTSV() {
    if (!scenarioLastRows.length) return;

    const headers = ["å®Œæˆæ¡ä»¶", "å¯å…‘æ¢å¥–åŠ±", "è·ç¦»ä¸‹ä¸€æ¡£ä½"];
    const lines = [headers.join("\t")];

    scenarioLastRows.forEach(r => {
      lines.push([r["å®Œæˆæ¡ä»¶"], r["å¯å…‘æ¢å¥–åŠ±"], r["è·ç¦»ä¸‹ä¸€æ¡£ä½"]].join("\t"));
    });

    const text = lines.join("\n");
    navigator.clipboard.writeText(text)
      .then(() => alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆTSVï¼Œå¯ç›´æ¥ç²˜è´´åˆ° Excelï¼‰"))
      .catch(() => alert("å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨å¯èƒ½ç¦æ­¢å‰ªè´´æ¿æƒé™ã€‚ä½ å¯ä»¥æ‰‹åŠ¨é€‰ä¸­è¡¨æ ¼å¤åˆ¶ã€‚"));
  }

  function exportScenarioToXlsx() {
    if (typeof XLSX === "undefined") {
      alert("å½“å‰ç¯å¢ƒæ— æ³•ä½¿ç”¨ Excel å¯¼å‡ºåŠŸèƒ½ã€‚");
      return;
    }
    if (!scenarioLastRows.length) return;

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(scenarioLastRows, { header: ["å®Œæˆæ¡ä»¶", "å¯å…‘æ¢å¥–åŠ±", "è·ç¦»ä¸‹ä¸€æ¡£ä½"] });
    XLSX.utils.book_append_sheet(wb, ws, "Scenario");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    XLSX.writeFile(wb, `æƒ…æ™¯åˆ†æ_${y}${m}${d}.xlsx`);
  }

  // ====== äº‹ä»¶ç»‘å®š ======
  document.getElementById("addEarnForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("earnName").value.trim();
    const points = clampNonNegInt(document.getElementById("earnPoints").value);
    const once = document.getElementById("earnOnce").checked;

    if (!name) return;

    earnActions.push({ id: nextId++, name, points, once });
    document.getElementById("earnName").value = "";
    document.getElementById("earnPoints").value = "";
    document.getElementById("earnOnce").checked = false;

    renderEarnActions();
    renderCalcTables();
    renderScenarioEarn();
  });

  document.getElementById("addSpendForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("spendName").value.trim();
    const points = clampNonNegInt(document.getElementById("spendPoints").value);
    if (!name) return;

    spendActions.push({ id: nextId++, name, points });
    document.getElementById("spendName").value = "";
    document.getElementById("spendPoints").value = "";

    renderSpendActions();
    renderCalcTables();
  });

  document.getElementById("addInviteRuleForm").addEventListener("submit", e => {
    e.preventDefault();
    const cond = document.getElementById("inviteCondition").value.trim();
    const minVal = clampNonNegInt(document.getElementById("inviteMin").value);
    const maxVal = clampNonNegInt(document.getElementById("inviteMax").value);
    const ptsVal = clampNonNegInt(document.getElementById("invitePoints").value);

    if (!cond) return;
    if (maxVal < minVal) {
      alert("ç»“æŸäººæ•°ä¸èƒ½å°äºèµ·å§‹äººæ•°ã€‚");
      return;
    }

    inviteRules.push({ id: nextId++, condition: cond, min: minVal, max: maxVal, points: ptsVal });

    document.getElementById("inviteMin").value = "";
    document.getElementById("inviteMax").value = "";
    document.getElementById("invitePoints").value = "";

    renderInviteRules();
    renderCalcTables();
  });

  document.getElementById("calcButton").addEventListener("click", calculatePoints);
  document.getElementById("resetCountsButton").addEventListener("click", resetAllCounts);

  // all once doneï¼ˆæ¨¡æ‹ŸåŒºï¼‰
  allOnceDoneCheckbox.addEventListener("change", () => {
    applyAllOnceDoneToCalc();
  });

  // ä¿å­˜/è½½å…¥/æ¸…é™¤/å¯¼å…¥å¯¼å‡º
  document.getElementById("saveConfigButton").addEventListener("click", saveConfig);
  document.getElementById("loadConfigButton").addEventListener("click", () => loadConfig(true));
  document.getElementById("clearConfigButton").addEventListener("click", clearConfig);
  document.getElementById("exportXlsxButton").addEventListener("click", exportConfigToXlsx);

  document.getElementById("importXlsxButton").addEventListener("click", () => {
    const input = document.getElementById("xlsxFileInput");
    input.value = "";
    input.click();
  });

  document.getElementById("xlsxFileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (file) importConfigFromXlsx(file);
  });

  // æƒ…æ™¯åˆ†æäº‹ä»¶
  scenarioAllOnceDone.addEventListener("change", applyScenarioAllOnceDone);

  scenarioRunBtn.addEventListener("click", runScenario);
  scenarioCopyBtn.addEventListener("click", copyScenarioTSV);
  scenarioExportBtn.addEventListener("click", exportScenarioToXlsx);

  // ====== é»˜è®¤è§„åˆ™ï¼ˆæŒ‰ä½ ç»™çš„é‚£å¥—ï¼‰ ======
  function initDefaults() {
    nextId = 1;

    earnActions = [
      { id: nextId++, name: "æ³¨å†ŒæˆåŠŸ", points: 5, once: true },
      { id: nextId++, name: "æƒé™é…ç½®æˆåŠŸ", points: 5, once: true },
      { id: nextId++, name: "ä½¿ç”¨ä¸€æ¬¡äººè®¾å›å¤", points: 5, once: true },
      { id: nextId++, name: "åŠ æŸšæŸšAIç²‰ä¸ç¾¤", points: 5, once: true },
      { id: nextId++, name: "å…³æ³¨å°çº¢ä¹¦å®˜æ–¹è´¦å·", points: 5, once: true },
      { id: nextId++, name: "åº”ç”¨å•†åº—å¥½è¯„", points: 5, once: true },
      { id: nextId++, name: "ä¼šå‘˜å……å€¼ï¼ˆæœˆï¼‰", points: 18, once: false },
      { id: nextId++, name: "ä¼šå‘˜å……å€¼ï¼ˆå­£ï¼‰", points: 54, once: false },
      { id: nextId++, name: "ä¼šå‘˜å……å€¼ï¼ˆå¹´ï¼‰", points: 216, once: false }
    ];

    spendActions = [
      { id: nextId++, name: "å…‘æ¢1å¤©ä¼šå‘˜", points: 35 },
      { id: nextId++, name: "å…‘æ¢3å¤©ä¼šå‘˜", points: 100 },
      { id: nextId++, name: "å…‘æ¢1å‘¨ä¼šå‘˜", points: 210 },
      { id: nextId++, name: "å…‘æ¢1ä¸ªæœˆä¼šå‘˜", points: 880 },
      { id: nextId++, name: "å…‘æ¢3ä¸ªæœˆä¼šå‘˜", points: 2550 },
      { id: nextId++, name: "å…‘æ¢6ä¸ªæœˆä¼šå‘˜", points: 4800 },
      { id: nextId++, name: "å…‘æ¢1å¹´ä¼šå‘˜", points: 7260 }
    ];

    inviteRules = [
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 0, max: 1, points: 10 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 2, max: 5, points: 20 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 6, max: 20, points: 30 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 21, max: 50, points: 40 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 51, max: 100, points: 80 },

      { id: nextId++, condition: "è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜", min: 0, max: 1, points: 10 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜", min: 2, max: 5, points: 20 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜", min: 6, max: 20, points: 30 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜", min: 21, max: 50, points: 40 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜", min: 51, max: 100, points: 80 },

      { id: nextId++, condition: "è¢«é‚€è¯·äººå®Œæˆä»˜è´¹", min: 0, max: 100, points: 20 }
    ];

    recomputeNextId();

    renderEarnActions();
    renderSpendActions();
    renderInviteRules();
    renderCalcTables();
    renderScenarioEarn();
    renderScenarioCondCheckboxes();
  }

  function init() {
    const loaded = loadConfig(false);
    if (!loaded) initDefaults();
    else {
      // å·²è½½å…¥ä¹Ÿè¦åˆå§‹åŒ–æƒ…æ™¯åˆ†æåŒºåŸŸ
      renderScenarioEarn();
      renderScenarioCondCheckboxes();
    }
  }

  init();
</script>

</body>
</html>
