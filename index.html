<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- æ ·å¼ -->
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .container {
      max-width: 1100px;
      margin: 24px auto;
      padding: 16px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
    }

    .section h2 {
      font-size: 18px;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section h2 span.badge {
      font-size: 12px;
      background: #eef2ff;
      color: #4f46e5;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .section-desc {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }

    form.inline-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    input[type="text"],
    input[type="number"],
    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      min-width: 0;
    }

    input[type="number"] {
      width: 110px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    button.primary {
      background: #4f46e5;
      color: #ffffff;
    }

    button.secondary {
      background: #e5e7eb;
      color: #374151;
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 4px;
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      background: #f9fafb;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .empty-tip {
      font-size: 12px;
      color: #9ca3af;
      padding: 4px 0;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .calc-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 768px) {
      .calc-columns {
        grid-template-columns: 1fr;
      }
    }

    .calc-section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .result-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      display: grid;
      gap: 4px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
    }

    .result-label {
      color: #6b7280;
    }

    .result-value {
      font-weight: 600;
    }

    .result-balance.positive {
      color: #16a34a;
    }

    .result-balance.negative {
      color: #b91c1c;
    }

    .footer-tip {
      margin-top: 8px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>

  <!-- ç”¨äºå¯¼å‡º/å¯¼å…¥ Excel çš„åº“ï¼ˆSheetJSï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <h1>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</h1>
  <div class="subtitle">
    å…ˆé…ç½®ã€Œæ€ä¹ˆèµšåˆ†ã€ã€Œæ€ä¹ˆèŠ±åˆ†ã€å’Œã€Œé‚€è¯·ç³»ç»Ÿã€ï¼Œå†ç”¨æ¨¡æ‹Ÿå™¨è¯•ç®—ä¸åŒè¡Œä¸ºæ¬¡æ•°ä¸‹ï¼Œæ€»ç§¯åˆ†å’Œå‰©ä½™ç§¯åˆ†æ˜¯å¤šå°‘ã€‚
  </div>

  <!-- 1. èµšç§¯åˆ†å…¥å£ -->
  <section class="section" id="earn-section">
    <h2>
      1. èµšç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¥æºé…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå®Œæˆæ–°æ‰‹ä»»åŠ¡ +100 åˆ†ã€æ¯æ—¥ç­¾åˆ° +10 åˆ†ã€å®Œæˆè®¢å• +5 åˆ†ç­‰ã€‚
    </div>
    <form class="inline-form" id="addEarnForm">
      <input type="text" id="earnName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šæ¯æ—¥ç­¾åˆ°ï¼‰" required />
      <input type="number" id="earnPoints" placeholder="æ¯æ¬¡è·å¾—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">
        + æ·»åŠ èµšç§¯åˆ†é€”å¾„
      </button>
    </form>
    <div id="earnListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 45%;">é€”å¾„åç§°</th>
          <th style="width: 30%;">æ¯æ¬¡è·å¾—ç§¯åˆ†</th>
          <th style="width: 25%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="earnTableBody"></tbody>
      </table>
      <div id="earnEmptyTip" class="empty-tip">
        è¿˜æ²¡æœ‰é…ç½®èµšç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚
      </div>
    </div>
  </section>

  <!-- 2. èŠ±ç§¯åˆ†å…¥å£ -->
  <section class="section" id="spend-section">
    <h2>
      2. èŠ±ç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¶ˆè€—é…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå…‘æ¢ä¼˜æƒ åˆ¸ -100 åˆ†ã€æŠ½å¥–ä¸€æ¬¡ -20 åˆ†ã€è§£é”ä¼šå‘˜æƒç›Š -500 åˆ†ç­‰ã€‚
    </div>
    <form class="inline-form" id="addSpendForm">
      <input type="text" id="spendName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šå…‘æ¢5å…ƒåˆ¸ï¼‰" required />
      <input type="number" id="spendPoints" placeholder="æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">
        + æ·»åŠ èŠ±ç§¯åˆ†é€”å¾„
      </button>
    </form>
    <div id="spendListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 45%;">é€”å¾„åç§°</th>
          <th style="width: 30%;">æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†</th>
          <th style="width: 25%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="spendTableBody"></tbody>
      </table>
      <div id="spendEmptyTip" class="empty-tip">
        è¿˜æ²¡æœ‰é…ç½®èŠ±ç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚
      </div>
    </div>
  </section>

  <!-- 3. é‚€è¯·ç³»ç»Ÿé…ç½® -->
  <section class="section" id="invite-section">
    <h2>
      3. é‚€è¯·ç³»ç»Ÿï¼ˆé˜¶æ¢¯å¥–åŠ±ï¼‰
      <span class="badge">æŒ‰é‚€è¯·äººæ•°åŒºé—´è®¾ç½®å¥–åŠ±</span>
    </h2>
    <div class="section-desc">
      æ¯æ¡è§„åˆ™å½¢å¦‚ï¼šé‚€è¯·ã€minã€‘è‡³ã€maxã€‘ä¸ªç”¨æˆ·ï¼Œè¢«é‚€è¯·äººã€Œæ¡ä»¶ã€ï¼Œå¾—ã€ç§¯åˆ†ã€‘ç§¯åˆ† / äººã€‚<br>
      è®¡ç®—æ—¶ä¼šæŒ‰åŒºé—´æ‹†æ®µç´¯åŠ ï¼Œä¾‹å¦‚ 0â€“1 äºº 10 åˆ†/äººï¼Œ2â€“5 äºº 20 åˆ†/äººï¼Œæ€»å…±é‚€è¯· 4 äºº â†’ 1Ã—10 + 3Ã—20ã€‚
    </div>
    <form class="inline-form" id="addInviteRuleForm">
      <select id="inviteCondition">
        <option value="è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ">è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ</option>
        <option value="è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜å¥–åŠ±">è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜å¥–åŠ±</option>
        <option value="è¢«é‚€è¯·äººå®Œæˆæœˆåº¦ä»˜è´¹">è¢«é‚€è¯·äººå®Œæˆæœˆåº¦ä»˜è´¹</option>
        <option value="è¢«é‚€è¯·äººå®Œæˆå­£åº¦ä»˜è´¹">è¢«é‚€è¯·äººå®Œæˆå­£åº¦ä»˜è´¹</option>
        <option value="è¢«é‚€è¯·äººå®Œæˆå¹´åº¦ä»˜è´¹">è¢«é‚€è¯·äººå®Œæˆå¹´åº¦ä»˜è´¹</option>
      </select>
      <input type="number" id="inviteMin" placeholder="èµ·å§‹äººæ•°ï¼ˆminï¼‰" min="0" step="1" required />
      <input type="number" id="inviteMax" placeholder="ç»“æŸäººæ•°ï¼ˆmaxï¼‰" min="0" step="1" required />
      <input type="number" id="invitePoints" placeholder="æ¯äººç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">
        + æ·»åŠ é‚€è¯·è§„åˆ™
      </button>
    </form>
    <div id="inviteRuleListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 30%;">è¢«é‚€è¯·äººæ¡ä»¶</th>
          <th style="width: 40%;">é‚€è¯·äººæ•°åŒºé—´</th>
          <th style="width: 20%;">æ¯äººç§¯åˆ†</th>
          <th style="width: 10%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="inviteRuleTableBody"></tbody>
      </table>
      <div id="inviteRuleEmptyTip" class="empty-tip">
        è¿˜æ²¡æœ‰é…ç½®é‚€è¯·è§„åˆ™ï¼Œå¯ä»¥å…ˆä¸ºã€Œè¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸã€æ·»åŠ  0â€“1ã€2â€“5ã€6â€“10 ç­‰åŒºé—´ã€‚
      </div>
    </div>
  </section>

  <!-- 4. æ¨¡æ‹Ÿè®¡ç®— -->
  <section class="section" id="calc-section">
    <h2>
      4. ç§¯åˆ†æ¨¡æ‹Ÿè®¡ç®—
      <span class="badge">ä½¿ç”¨æ¬¡æ•° â†’ å‰©ä½™ç§¯åˆ†</span>
    </h2>
    <div class="section-desc">
      ç¬¬ä¸€æ­¥ï¼šå¡«å†™æ¯ç§ã€Œèµšç§¯åˆ†ã€é€”å¾„çš„ä½¿ç”¨æ¬¡æ•°ï¼Œç®—å‡ºæ€»å…±èµšäº†å¤šå°‘åˆ†ã€‚<br>
      ç¬¬äºŒæ­¥ï¼šå¡«å†™æ¯ç§ã€ŒèŠ±ç§¯åˆ†ã€é€”å¾„çš„ä½¿ç”¨æ¬¡æ•°ï¼Œçœ‹èŠ±æ‰å¤šå°‘åˆ†ã€‚<br>
      ç¬¬ä¸‰æ­¥ï¼šå¡«å†™é‚€è¯·ç³»ç»Ÿä¸­å„æ¡ä»¶çš„é‚€è¯·äººæ•°ï¼ŒæŒ‰é˜¶æ¢¯è§„åˆ™è‡ªåŠ¨ç®—å‡ºé‚€è¯·ç§¯åˆ†ã€‚
    </div>

    <div class="calc-columns">
      <!-- å·¦ä¾§ï¼šèµšç§¯åˆ† + é‚€è¯·ç³»ç»Ÿ -->
      <div>
        <div class="calc-section-title">
          <strong>èµšç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¥æºåˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>
        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡ç§¯åˆ†</th>
            <th>ä½¿ç”¨æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="earnCalcBody"></tbody>
        </table>
        <div id="earnCalcEmptyTip" class="empty-tip">
          æš‚æ— èµšç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€Œèµšç§¯åˆ†çš„é€”å¾„ã€ã€‚
        </div>

        <!-- é‚€è¯·ç³»ç»Ÿç§¯åˆ† -->
        <div style="margin-top: 16px;">
          <div class="calc-section-title">
            <strong>é‚€è¯·ç³»ç»Ÿç§¯åˆ†</strong>
            <span class="tag">æ ¹æ®é˜¶æ¢¯è§„åˆ™è‡ªåŠ¨è®¡ç®—</span>
          </div>
          <table>
            <thead>
            <tr>
              <th>è¢«é‚€è¯·äººæ¡ä»¶</th>
              <th>é‚€è¯·äººæ•°</th>
              <th>å°è®¡ç§¯åˆ†</th>
            </tr>
            </thead>
            <tbody id="inviteCalcBody"></tbody>
          </table>
          <div id="inviteCalcEmptyTip" class="empty-tip">
            å½“å‰å°šæœªä¸ºä»»æ„æ¡ä»¶é…ç½®é‚€è¯·è§„åˆ™ï¼Œå³ä½¿å¡«å†™äººæ•°ä¹Ÿä¸ä¼šäº§ç”Ÿç§¯åˆ†ã€‚
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šèŠ±ç§¯åˆ† -->
      <div>
        <div class="calc-section-title">
          <strong>èŠ±ç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¶ˆè€—åˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>
        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡èŠ±è´¹</th>
            <th>ä½¿ç”¨æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="spendCalcBody"></tbody>
        </table>
        <div id="spendCalcEmptyTip" class="empty-tip">
          æš‚æ— èŠ±ç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€ŒèŠ±ç§¯åˆ†çš„é€”å¾„ã€ã€‚
        </div>
      </div>
    </div>

    <div style="margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="calcButton" class="primary">
        ğŸ§® è®¡ç®—ç§¯åˆ†
      </button>
      <button id="resetCountsButton" class="secondary">
        æ¸…ç©ºæ‰€æœ‰æ¬¡æ•°
      </button>
    </div>

    <div class="result-box">
      <div class="result-row">
        <span class="result-label">æ€»å…±è·å¾—ç§¯åˆ†ï¼ˆå«é‚€è¯·ï¼‰ï¼š</span>
        <span class="result-value" id="totalEarned">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">æ€»å…±èŠ±è´¹ç§¯åˆ†ï¼š</span>
        <span class="result-value" id="totalSpent">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">å‰©ä½™ç§¯åˆ†ï¼š</span>
        <span class="result-value result-balance" id="balance">0</span>
      </div>
    </div>

    <div class="footer-tip">
      å»ºè®®ï¼šå¯ä»¥å…ˆå¯¼å‡ºä¸€ç‰ˆ Excel å½“ä½œã€Œç§¯åˆ†ç­–ç•¥æ–¹æ¡ˆ v1ã€ï¼Œä¹‹åè°ƒæ•´è§„åˆ™å†å¦å­˜ä¸€ç‰ˆï¼Œæ–¹ä¾¿å¯¹æ¯”ä¸åŒæ–¹æ¡ˆã€‚
    </div>

    <!-- ä¿å­˜ / è½½å…¥ / å¯¼å‡º / å¯¼å…¥æŒ‰é’® -->
    <div style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:8px;">
      <button id="saveConfigButton" class="secondary">ğŸ’¾ ä¿å­˜å½“å‰ç§¯åˆ†è§„åˆ™</button>
      <button id="loadConfigButton" class="secondary">ğŸ“‚ è½½å…¥å·²ä¿å­˜è§„åˆ™</button>
      <button id="clearConfigButton" class="secondary">ğŸ§¹ æ¸…é™¤æœ¬åœ°ä¿å­˜</button>
      <button id="exportXlsxButton" class="secondary">ğŸ“‘ å¯¼å‡ºè§„åˆ™ä¸º Excel</button>
      <button id="importXlsxButton" class="secondary">ğŸ“¥ å¯¼å…¥è§„åˆ™ï¼ˆExcelï¼‰</button>
      <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" style="display:none;" />
    </div>
  </section>
</div>

<script>
  // ====== å¸¸é‡ ======
  const INVITE_CONDITIONS = [
    "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ",
    "è¢«é‚€è¯·äººé¦–æ¬¡ä½¿ç”¨é”®ç›˜å¥–åŠ±",
    "è¢«é‚€è¯·äººå®Œæˆæœˆåº¦ä»˜è´¹",
    "è¢«é‚€è¯·äººå®Œæˆå­£åº¦ä»˜è´¹",
    "è¢«é‚€è¯·äººå®Œæˆå¹´åº¦ä»˜è´¹"
  ];
  const STORAGE_KEY = "points-config-v2";

  // ====== å…¨å±€æ•°æ® ======
  let earnActions = [];
  let spendActions = [];
  let inviteRules = []; // {id, condition, min, max, points}
  let nextId = 1;

  // DOM å¼•ç”¨
  const earnTableBody = document.getElementById("earnTableBody");
  const spendTableBody = document.getElementById("spendTableBody");
  const earnEmptyTip = document.getElementById("earnEmptyTip");
  const spendEmptyTip = document.getElementById("spendEmptyTip");

  const inviteRuleTableBody = document.getElementById("inviteRuleTableBody");
  const inviteRuleEmptyTip = document.getElementById("inviteRuleEmptyTip");

  const earnCalcBody = document.getElementById("earnCalcBody");
  const spendCalcBody = document.getElementById("spendCalcBody");
  const earnCalcEmptyTip = document.getElementById("earnCalcEmptyTip");
  const spendCalcEmptyTip = document.getElementById("spendCalcEmptyTip");

  const inviteCalcBody = document.getElementById("inviteCalcBody");
  const inviteCalcEmptyTip = document.getElementById("inviteCalcEmptyTip");

  const totalEarnedSpan = document.getElementById("totalEarned");
  const totalSpentSpan = document.getElementById("totalSpent");
  const balanceSpan = document.getElementById("balance");

  // ====== å·¥å…·ï¼šé‡ç®— nextId ======
  function recomputeNextId() {
    const all = [...earnActions, ...spendActions, ...inviteRules];
    if (all.length === 0) {
      nextId = 1;
    } else {
      nextId = Math.max(...all.map(a => a.id || 0)) + 1;
    }
  }

  // ====== èµšç§¯åˆ†åˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ç§¯åˆ†ï¼‰ ======
  function renderEarnActions() {
    earnTableBody.innerHTML = "";
    if (earnActions.length === 0) {
      earnEmptyTip.style.display = "block";
    } else {
      earnEmptyTip.style.display = "none";
    }

    earnActions.forEach(action => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      const pointsTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = action.points;
      input.style.width = "80px";
      input.addEventListener("change", () => {
        const val = Number(input.value);
        action.points = isNaN(val) || val < 0 ? 0 : val;
        input.value = action.points;
        renderCalcTables();
      });
      pointsTd.appendChild(input);
      const span = document.createElement("span");
      span.textContent = " åˆ†";
      span.style.marginLeft = "4px";
      pointsTd.appendChild(span);
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        earnActions = earnActions.filter(a => a.id !== action.id);
        renderEarnActions();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      earnTableBody.appendChild(tr);
    });
  }

  // ====== èŠ±ç§¯åˆ†åˆ—è¡¨ï¼ˆå¯ç¼–è¾‘ç§¯åˆ†ï¼‰ ======
  function renderSpendActions() {
    spendTableBody.innerHTML = "";
    if (spendActions.length === 0) {
      spendEmptyTip.style.display = "block";
    } else {
      spendEmptyTip.style.display = "none";
    }

    spendActions.forEach(action => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      const pointsTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = action.points;
      input.style.width = "80px";
      input.addEventListener("change", () => {
        const val = Number(input.value);
        action.points = isNaN(val) || val < 0 ? 0 : val;
        input.value = action.points;
        renderCalcTables();
      });
      pointsTd.appendChild(input);
      const span = document.createElement("span");
      span.textContent = " åˆ†";
      span.style.marginLeft = "4px";
      pointsTd.appendChild(span);
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        spendActions = spendActions.filter(a => a.id !== action.id);
        renderSpendActions();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      spendTableBody.appendChild(tr);
    });
  }

  // ====== é‚€è¯·è§„åˆ™åˆ—è¡¨ ======
  function renderInviteRules() {
    inviteRuleTableBody.innerHTML = "";
    if (inviteRules.length === 0) {
      inviteRuleEmptyTip.style.display = "block";
    } else {
      inviteRuleEmptyTip.style.display = "none";
    }

    // æŒ‰æ¡ä»¶ + min æ’åºï¼Œæ›´æ¸…æ™°
    const sorted = [...inviteRules].sort((a, b) => {
      if (a.condition === b.condition) return a.min - b.min || a.max - b.max;
      return INVITE_CONDITIONS.indexOf(a.condition) - INVITE_CONDITIONS.indexOf(b.condition);
    });

    sorted.forEach(rule => {
      const tr = document.createElement("tr");

      const condTd = document.createElement("td");
      condTd.textContent = rule.condition;
      tr.appendChild(condTd);

      const rangeTd = document.createElement("td");
      rangeTd.textContent = `${rule.min} ï½ ${rule.max} äºº`;
      tr.appendChild(rangeTd);

      const pointsTd = document.createElement("td");
      pointsTd.textContent = rule.points + " åˆ†/äºº";
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ ";
      delBtn.className = "danger";
      delBtn.style.padding = "4px 8px";
      delBtn.addEventListener("click", () => {
        inviteRules = inviteRules.filter(r => r.id !== rule.id);
        renderInviteRules();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      inviteRuleTableBody.appendChild(tr);
    });
  }

  // ====== è®¡ç®—ï¼šæ ¹æ®æŸä¸ªæ¡ä»¶çš„é˜¶æ¢¯è§„åˆ™ï¼Œç®—é‚€è¯·ç§¯åˆ† ======
  function calcInvitePointsForCondition(condition, totalInvites) {
    const rules = inviteRules.filter(r => r.condition === condition);
    if (rules.length === 0 || totalInvites <= 0) return 0;

    const sorted = [...rules].sort((a, b) => a.min - b.min || a.max - b.max);
    let total = 0;

    sorted.forEach(rule => {
      const start = Math.max(rule.min, 1); // é‚€è¯·äººæ•°ä» 1 å¼€å§‹è®¡
      if (totalInvites < start) return;
      const end = Math.min(rule.max, totalInvites);
      if (end < start) return;
      const count = end - start + 1;
      total += count * rule.points;
    });

    return total;
  }

  // ====== æ¸²æŸ“æ¨¡æ‹ŸåŒºåŸŸ ======
  function renderCalcTables() {
    // èµšç§¯åˆ†
    earnCalcBody.innerHTML = "";
    if (earnActions.length === 0) {
      earnCalcEmptyTip.style.display = "block";
    } else {
      earnCalcEmptyTip.style.display = "none";
      earnActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points;
        tr.appendChild(pointsTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.dataset.actionId = action.id;
        input.className = "earn-count-input";
        input.style.width = "80px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.actionId = action.id;
        subtotalTd.className = "earn-subtotal";
        tr.appendChild(subtotalTd);

        earnCalcBody.appendChild(tr);
      });
    }

    // èŠ±ç§¯åˆ†
    spendCalcBody.innerHTML = "";
    if (spendActions.length === 0) {
      spendCalcEmptyTip.style.display = "block";
    } else {
      spendCalcEmptyTip.style.display = "none";
      spendActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points;
        tr.appendChild(pointsTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.dataset.actionId = action.id;
        input.className = "spend-count-input";
        input.style.width = "80px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.actionId = action.id;
        subtotalTd.className = "spend-subtotal";
        tr.appendChild(subtotalTd);

        spendCalcBody.appendChild(tr);
      });
    }

    // é‚€è¯·ç³»ç»Ÿæ¨¡æ‹Ÿ
    inviteCalcBody.innerHTML = "";
    const hasInviteRules = inviteRules.length > 0;
    if (!hasInviteRules) {
      inviteCalcEmptyTip.style.display = "block";
    } else {
      inviteCalcEmptyTip.style.display = "none";
    }

    INVITE_CONDITIONS.forEach(cond => {
      const tr = document.createElement("tr");

      const condTd = document.createElement("td");
      condTd.textContent = cond;
      tr.appendChild(condTd);

      const countTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = "0";
      input.dataset.condition = cond;
      input.className = "invite-count-input";
      input.style.width = "80px";
      countTd.appendChild(input);
      tr.appendChild(countTd);

      const subtotalTd = document.createElement("td");
      subtotalTd.textContent = "0";
      subtotalTd.dataset.condition = cond;
      subtotalTd.className = "invite-subtotal";
      tr.appendChild(subtotalTd);

      inviteCalcBody.appendChild(tr);
    });
  }

  // ====== è®¡ç®—ç§¯åˆ†æ€»å’Œ ======
  function calculatePoints() {
    let totalEarned = 0;
    let totalSpent = 0;

    // èµšç§¯åˆ†
    document.querySelectorAll(".earn-count-input").forEach(input => {
      const id = parseInt(input.dataset.actionId, 10);
      const action = earnActions.find(a => a.id === id);
      if (!action) return;
      const count = Number(input.value) || 0;
      const subtotal = count * action.points;
      totalEarned += subtotal;
      const td = document.querySelector('.earn-subtotal[data-action-id="' + id + '"]');
      if (td) td.textContent = subtotal;
    });

    // èŠ±ç§¯åˆ†
    document.querySelectorAll(".spend-count-input").forEach(input => {
      const id = parseInt(input.dataset.actionId, 10);
      const action = spendActions.find(a => a.id === id);
      if (!action) return;
      const count = Number(input.value) || 0;
      const subtotal = count * action.points;
      totalSpent += subtotal;
      const td = document.querySelector('.spend-subtotal[data-action-id="' + id + '"]');
      if (td) td.textContent = subtotal;
    });

    // é‚€è¯·ç³»ç»Ÿ
    document.querySelectorAll(".invite-count-input").forEach(input => {
      const cond = input.dataset.condition;
      const count = Number(input.value) || 0;
      const subtotal = calcInvitePointsForCondition(cond, count);
      totalEarned += subtotal;
      const td = document.querySelector('.invite-subtotal[data-condition="' + cond + '"]');
      if (td) td.textContent = subtotal;
    });

    const balance = totalEarned - totalSpent;
    totalEarnedSpan.textContent = totalEarned;
    totalSpentSpan.textContent = totalSpent;
    balanceSpan.textContent = balance;
    balanceSpan.classList.remove("positive", "negative");
    if (balance > 0) balanceSpan.classList.add("positive");
    else if (balance < 0) balanceSpan.classList.add("negative");
  }

  function resetAllCounts() {
    document.querySelectorAll(".earn-count-input, .spend-count-input, .invite-count-input")
      .forEach(input => input.value = "0");
    document.querySelectorAll(".earn-subtotal, .spend-subtotal, .invite-subtotal")
      .forEach(td => td.textContent = "0");
    totalEarnedSpan.textContent = "0";
    totalSpentSpan.textContent = "0";
    balanceSpan.textContent = "0";
    balanceSpan.classList.remove("positive", "negative");
  }

  // ====== æœ¬åœ°ä¿å­˜ / è½½å…¥ ======
  function saveConfig() {
    const data = { earnActions, spendActions, inviteRules };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert("å·²ä¿å­˜åˆ°æœ¬æµè§ˆå™¨ï¼ˆåŒä¸€å°è®¾å¤‡ã€åŒä¸€æµè§ˆå™¨ä¸‹ä¼šä¿ç•™ï¼‰");
    } catch (e) {
      console.error(e);
      alert("ä¿å­˜å¤±è´¥ï¼šå¯èƒ½æ˜¯æµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨ã€‚");
    }
  }

  function loadConfig(showAlert = true) {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      if (showAlert) alert("æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return false;
    }
    try {
      const data = JSON.parse(raw);
      earnActions = Array.isArray(data.earnActions) ? data.earnActions : [];
      spendActions = Array.isArray(data.spendActions) ? data.spendActions : [];
      inviteRules = Array.isArray(data.inviteRules) ? data.inviteRules : [];
      recomputeNextId();

      renderEarnActions();
      renderSpendActions();
      renderInviteRules();
      renderCalcTables();
      resetAllCounts();

      if (showAlert) alert("å·²è½½å…¥æœ¬åœ°ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return true;
    } catch (e) {
      console.error(e);
      if (showAlert) alert("ä¿å­˜çš„æ•°æ®å·²æŸåï¼Œæ— æ³•è¯»å–ã€‚");
      return false;
    }
  }

  function clearConfig() {
    localStorage.removeItem(STORAGE_KEY);
    alert("å·²æ¸…é™¤æœ¬åœ°ä¿å­˜ã€‚å½“å‰é¡µé¢ä¸Šçš„è§„åˆ™ä¸ä¼šè‡ªåŠ¨æ¸…ç©ºï¼Œå¦‚éœ€é‡ç½®è¯·æ‰‹åŠ¨ä¿®æ”¹æˆ–å¯¼å…¥å…¶ä»–æ–¹æ¡ˆã€‚");
  }

  // ====== å¯¼å‡º Excel ======
  function exportConfigToXlsx() {
    if (typeof XLSX === "undefined") {
      alert("å½“å‰ç¯å¢ƒæ— æ³•ä½¿ç”¨ Excel å¯¼å‡ºåŠŸèƒ½ã€‚");
      return;
    }

    const wb = XLSX.utils.book_new();

    // Sheet1ï¼šèµšç§¯åˆ†è§„åˆ™
    const earnData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†"]];
    earnActions.forEach(a => {
      earnData.push(["èµšç§¯åˆ†", a.name, a.points]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(earnData), "EarnRules");

    // Sheet2ï¼šèŠ±ç§¯åˆ†è§„åˆ™
    const spendData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†"]];
    spendActions.forEach(a => {
      spendData.push(["èŠ±ç§¯åˆ†", a.name, a.points]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(spendData), "SpendRules");

    // Sheet3ï¼šé‚€è¯·è§„åˆ™
    const inviteData = [["è¢«é‚€è¯·äººæ¡ä»¶", "èµ·å§‹äººæ•°", "ç»“æŸäººæ•°", "æ¯äººç§¯åˆ†"]];
    inviteRules.forEach(r => {
      inviteData.push([r.condition, r.min, r.max, r.points]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(inviteData), "InviteRules");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    const fileName = `ç§¯åˆ†è§„åˆ™_${y}${m}${d}.xlsx`;

    XLSX.writeFile(wb, fileName);
  }

  // ====== ä» Excel å¯¼å…¥è§„åˆ™ ======
  function importConfigFromXlsx(file) {
    if (!file) return;
    const reader = new FileReader();

    reader.onload = function (e) {
      try {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: "array" });

        const earnSheet = workbook.Sheets["EarnRules"];
        const spendSheet = workbook.Sheets["SpendRules"];
        const inviteSheet = workbook.Sheets["InviteRules"];

        if (!earnSheet || !spendSheet) {
          alert("Excel æ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å« EarnRules å’Œ SpendRules ä¸¤ä¸ª Sheetã€‚");
          return;
        }

        const earnJson = XLSX.utils.sheet_to_json(earnSheet);
        const spendJson = XLSX.utils.sheet_to_json(spendSheet);

        earnActions = earnJson.map((row, idx) => ({
          id: idx + 1,
          name: row["é€”å¾„åç§°"],
          points: Number(row["æ¯æ¬¡ç§¯åˆ†"]) || 0
        }));

        const base = earnActions.length + 1;

        spendActions = spendJson.map((row, idx) => ({
          id: base + idx,
          name: row["é€”å¾„åç§°"],
          points: Number(row["æ¯æ¬¡ç§¯åˆ†"]) || 0
        }));

        let inviteBase = base + spendActions.length;
        if (inviteSheet) {
          const inviteJson = XLSX.utils.sheet_to_json(inviteSheet);
          inviteRules = inviteJson.map((row, idx) => ({
            id: inviteBase + idx,
            condition: row["è¢«é‚€è¯·äººæ¡ä»¶"],
            min: Number(row["èµ·å§‹äººæ•°"]) || 0,
            max: Number(row["ç»“æŸäººæ•°"]) || 0,
            points: Number(row["æ¯äººç§¯åˆ†"]) || 0
          }));
        } else {
          inviteRules = [];
        }

        recomputeNextId();
        renderEarnActions();
        renderSpendActions();
        renderInviteRules();
        renderCalcTables();
        resetAllCounts();

        alert("å·²æˆåŠŸä» Excel å¯¼å…¥è§„åˆ™ï¼");
      } catch (err) {
        console.error(err);
        alert("Excel æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥å­—æ®µåæ˜¯å¦ä¸ºï¼šé€”å¾„åç§°ã€æ¯æ¬¡ç§¯åˆ† / è¢«é‚€è¯·äººæ¡ä»¶ã€èµ·å§‹äººæ•°ã€ç»“æŸäººæ•°ã€æ¯äººç§¯åˆ†ã€‚");
      }
    };

    reader.readAsArrayBuffer(file);
  }

  // ====== äº‹ä»¶ç»‘å®š ======
  document.getElementById("addEarnForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("earnName").value.trim();
    const pointsVal = Number(document.getElementById("earnPoints").value);
    if (!name || isNaN(pointsVal) || pointsVal < 0) return;
    earnActions.push({ id: nextId++, name, points: pointsVal });
    document.getElementById("earnName").value = "";
    document.getElementById("earnPoints").value = "";
    renderEarnActions();
    renderCalcTables();
  });

  document.getElementById("addSpendForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("spendName").value.trim();
    const pointsVal = Number(document.getElementById("spendPoints").value);
    if (!name || isNaN(pointsVal) || pointsVal < 0) return;
    spendActions.push({ id: nextId++, name, points: pointsVal });
    document.getElementById("spendName").value = "";
    document.getElementById("spendPoints").value = "";
    renderSpendActions();
    renderCalcTables();
  });

  document.getElementById("addInviteRuleForm").addEventListener("submit", e => {
    e.preventDefault();
    const cond = document.getElementById("inviteCondition").value;
    const minVal = Number(document.getElementById("inviteMin").value);
    const maxVal = Number(document.getElementById("inviteMax").value);
    const ptsVal = Number(document.getElementById("invitePoints").value);

    if (isNaN(minVal) || isNaN(maxVal) || isNaN(ptsVal) || minVal < 0 || maxVal < 0) {
      alert("äººæ•°ä¸ç§¯åˆ†å¿…é¡»ä¸ºéè´Ÿæ•°å­—ã€‚");
      return;
    }
    if (maxVal < minVal) {
      alert("ç»“æŸäººæ•°ä¸èƒ½å°äºèµ·å§‹äººæ•°ã€‚");
      return;
    }

    inviteRules.push({
      id: nextId++,
      condition: cond,
      min: minVal,
      max: maxVal,
      points: ptsVal
    });

    document.getElementById("inviteMin").value = "";
    document.getElementById("inviteMax").value = "";
    document.getElementById("invitePoints").value = "";

    renderInviteRules();
    renderCalcTables();
  });

  document.getElementById("calcButton").addEventListener("click", calculatePoints);
  document.getElementById("resetCountsButton").addEventListener("click", resetAllCounts);

  document.getElementById("saveConfigButton").addEventListener("click", saveConfig);
  document.getElementById("loadConfigButton").addEventListener("click", () => loadConfig(true));
  document.getElementById("clearConfigButton").addEventListener("click", clearConfig);
  document.getElementById("exportXlsxButton").addEventListener("click", exportConfigToXlsx);

  document.getElementById("importXlsxButton").addEventListener("click", () => {
    const input = document.getElementById("xlsxFileInput");
    input.value = "";
    input.click();
  });

  document.getElementById("xlsxFileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (file) importConfigFromXlsx(file);
  });

  // ====== åˆå§‹åŒ–ï¼šä¼˜å…ˆè½½å…¥æœ¬åœ°ä¿å­˜ï¼›æ²¡æœ‰åˆ™ç”¨ç¤ºä¾‹ ======
  function initExamples() {
    earnActions = [
      { id: nextId++, name: "å®Œæˆæ–°æ‰‹ä»»åŠ¡", points: 100 },
      { id: nextId++, name: "æ¯æ—¥ç­¾åˆ°", points: 10 },
      { id: nextId++, name: "å®Œæˆä¸€æ¬¡è®¢å•", points: 5 }
    ];
    spendActions = [
      { id: nextId++, name: "å…‘æ¢5å…ƒä¼˜æƒ åˆ¸", points: 100 },
      { id: nextId++, name: "ç§¯åˆ†æŠ½å¥–ä¸€æ¬¡", points: 20 },
      { id: nextId++, name: "è§£é”ä¼šå‘˜ä¸€å‘¨", points: 300 }
    ];
    inviteRules = [
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 0, max: 1, points: 10 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 2, max: 5, points: 20 }
    ];

    renderEarnActions();
    renderSpendActions();
    renderInviteRules();
    renderCalcTables();
  }

  function init() {
    const loaded = loadConfig(false);
    if (!loaded) initExamples();
  }

  init();
</script>
</body>
</html>
