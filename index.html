<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    body { margin: 0; padding: 0; background: #f3f4f6; color: #111827; }
    .container { max-width: 1100px; margin: 24px auto; padding: 16px; }
    h1 { font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: #6b7280; margin-bottom: 24px; font-size: 14px; }

    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.04);
    }
    .section h2 {
      font-size: 18px;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .section h2 span.badge {
      font-size: 12px;
      background: #eef2ff;
      color: #4f46e5;
      padding: 2px 8px;
      border-radius: 999px;
    }
    .section-desc { font-size: 13px; color: #6b7280; margin-bottom: 12px; }

    form.inline-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    input[type="text"], input[type="number"], select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      min-width: 0;
    }
    input[type="number"] { width: 110px; }
    input:focus, select:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.2);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    button.primary { background: #4f46e5; color: #ffffff; }
    button.secondary { background: #e5e7eb; color: #374151; }
    button.danger { background: #fee2e2; color: #b91c1c; }
    button:disabled { opacity: 0.6; cursor: default; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 6px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 6px 4px; text-align: left; vertical-align: top; }
    th { font-weight: 600; color: #4b5563; background: #f9fafb; }
    tr:last-child td { border-bottom: none; }

    .empty-tip { font-size: 12px; color: #9ca3af; padding: 4px 0; }
    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .calc-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 768px) { .calc-columns { grid-template-columns: 1fr; } }

    .calc-section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .result-box {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      display: grid;
      gap: 4px;
    }
    .result-row { display: flex; justify-content: space-between; gap: 10px; }
    .result-label { color: #6b7280; }
    .result-value { font-weight: 600; }
    .result-balance.positive { color: #16a34a; }
    .result-balance.negative { color: #b91c1c; }
    .footer-tip { margin-top: 8px; font-size: 11px; color: #9ca3af; }

    .tiny-switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #374151;
      user-select: none;
    }
    .tiny-switch input { transform: translateY(1px); }
    .muted { color: #9ca3af; }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 768px) { .mini-grid { grid-template-columns: 1fr; } }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      color: #374151;
      flex-wrap: wrap;
    }

    .check-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    @media (max-width: 768px) { .check-list { grid-template-columns: 1fr; } }

    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 12px;
      color: #374151;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fafafa;
    }
    .check-item input { margin-top: 2px; }
    .check-item .sub { color: #9ca3af; font-size: 11px; margin-top: 2px; }

    .row-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="container">
  <h1>ç§¯åˆ†ç³»ç»Ÿè®¾è®¡ä¸æ¨¡æ‹Ÿå°å·¥å…·</h1>
  <div class="subtitle">
    å…ˆé…ç½®ã€Œæ€ä¹ˆèµšåˆ†ã€ã€Œæ€ä¹ˆèŠ±åˆ†ã€å’Œã€Œé‚€è¯·ç³»ç»Ÿã€ï¼Œå†ç”¨æ¨¡æ‹Ÿå™¨è¯•ç®—ä¸åŒè¡Œä¸ºæ¬¡æ•°ä¸‹ï¼Œæ€»ç§¯åˆ†å’Œå‰©ä½™ç§¯åˆ†æ˜¯å¤šå°‘ã€‚
  </div>


  <div style="margin-top: 10px; display:flex; flex-wrap:wrap; gap:8px;">
    <button id="saveConfigButton" class="secondary">ğŸ’¾ ä¿å­˜å½“å‰ç§¯åˆ†è§„åˆ™</button>
    <button id="loadConfigButton" class="secondary">ğŸ“‚ è½½å…¥å·²ä¿å­˜è§„åˆ™</button>
    <button id="clearConfigButton" class="secondary">ğŸ§¹ æ¸…é™¤æœ¬åœ°ä¿å­˜</button>
    <button id="exportXlsxButton" class="secondary">ğŸ“‘ å¯¼å‡ºè§„åˆ™ä¸º Excel</button>
    <button id="importXlsxButton" class="secondary">ğŸ“¥ å¯¼å…¥è§„åˆ™ï¼ˆExcelï¼‰</button>
    <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" style="display:none;" />
  </div>
  <div class="footer-tip">
        
  </div>
  <!-- 1. èµšç§¯åˆ†å…¥å£ -->
  <section class="section" id="earn-section">
    <h2>
      1. èµšç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¥æºé…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå®Œæˆæ–°æ‰‹ä»»åŠ¡ +100 åˆ†ã€æ¯æ—¥ç­¾åˆ° +10 åˆ†ã€å®Œæˆè®¢å• +5 åˆ†ç­‰ã€‚
    </div>

    <form class="inline-form" id="addEarnForm">
      <input type="text" id="earnName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šæ¯æ—¥ç­¾åˆ°ï¼‰" required />
      <input type="number" id="earnPoints" placeholder="æ¯æ¬¡è·å¾—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">+ æ·»åŠ èµšç§¯åˆ†é€”å¾„</button>
    </form>

    <div id="earnListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 40%;">é€”å¾„åç§°</th>
          <th style="width: 20%;">æ¯æ¬¡è·å¾—ç§¯åˆ†</th>
          <th style="width: 25%;">ä¸€æ¬¡æ€§å¥–åŠ±</th>
          <th style="width: 15%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="earnTableBody"></tbody>
      </table>
      <div id="earnEmptyTip" class="empty-tip">è¿˜æ²¡æœ‰é…ç½®èµšç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚</div>
    </div>
  </section>

  <!-- 2. èŠ±ç§¯åˆ†å…¥å£ -->
  <section class="section" id="spend-section">
    <h2>
      2. èŠ±ç§¯åˆ†çš„é€”å¾„
      <span class="badge">ç§¯åˆ†æ¶ˆè€—é…ç½®</span>
    </h2>
    <div class="section-desc">
      ä¾‹å¦‚ï¼šå…‘æ¢ä¼˜æƒ åˆ¸ -100 åˆ†ã€æŠ½å¥–ä¸€æ¬¡ -20 åˆ†ã€è§£é”ä¼šå‘˜æƒç›Š -500 åˆ†ç­‰ã€‚
    </div>

    <form class="inline-form" id="addSpendForm">
      <input type="text" id="spendName" placeholder="é€”å¾„åç§°ï¼ˆå¦‚ï¼šå…‘æ¢5å…ƒåˆ¸ï¼‰" required />
      <input type="number" id="spendPoints" placeholder="æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">+ æ·»åŠ èŠ±ç§¯åˆ†é€”å¾„</button>
    </form>

    <div id="spendListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 45%;">é€”å¾„åç§°</th>
          <th style="width: 30%;">æ¯æ¬¡æ¶ˆè€—ç§¯åˆ†</th>
          <th style="width: 25%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="spendTableBody"></tbody>
      </table>
      <div id="spendEmptyTip" class="empty-tip">è¿˜æ²¡æœ‰é…ç½®èŠ±ç§¯åˆ†æ–¹å¼ï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€ä¸¤æ¡ç¤ºä¾‹ã€‚</div>
    </div>
  </section>

  <!-- 3. é‚€è¯·ç³»ç»Ÿé…ç½® -->
  <section class="section" id="invite-section">
    <h2>
      3. é‚€è¯·ç³»ç»Ÿï¼ˆé˜¶æ¢¯å¥–åŠ±ï¼‰
      <span class="badge">æŒ‰é‚€è¯·äººæ•°åŒºé—´è®¾ç½®å¥–åŠ±</span>
    </h2>
    <div class="section-desc">
      æ¯æ¡è§„åˆ™å½¢å¦‚ï¼šé‚€è¯·ã€minã€‘è‡³ã€maxã€‘ä¸ªç”¨æˆ·ï¼Œè¢«é‚€è¯·äººã€Œæ¡ä»¶ã€ï¼Œå¾—ã€ç§¯åˆ†ã€‘ç§¯åˆ† / äººã€‚<br>
      è®¡ç®—æ—¶ä¼šæŒ‰åŒºé—´æ‹†æ®µç´¯åŠ ï¼Œä¾‹å¦‚ 0â€“1 äºº 10 åˆ†/äººï¼Œ2â€“5 äºº 20 åˆ†/äººï¼Œæ€»å…±é‚€è¯· 4 äºº â†’ 1Ã—10 + 3Ã—20ã€‚
    </div>

    <form class="inline-form" id="addInviteRuleForm">
      <input type="text" id="inviteCondition" placeholder="è¢«é‚€è¯·äººæ¡ä»¶ï¼ˆå¦‚ï¼šæ³¨å†ŒæˆåŠŸï¼‰" required />
      <input type="number" id="inviteMin" placeholder="èµ·å§‹äººæ•°ï¼ˆminï¼‰" min="0" step="1" required />
      <input type="number" id="inviteMax" placeholder="ç»“æŸäººæ•°ï¼ˆmaxï¼‰" min="0" step="1" required />
      <input type="number" id="invitePoints" placeholder="æ¯äººç§¯åˆ†" min="0" step="1" required />
      <button type="submit" class="primary">+ æ·»åŠ é‚€è¯·è§„åˆ™</button>
    </form>

    <div id="inviteRuleListWrapper">
      <table>
        <thead>
        <tr>
          <th style="width: 30%;">è¢«é‚€è¯·äººæ¡ä»¶</th>
          <th style="width: 40%;">é‚€è¯·äººæ•°åŒºé—´</th>
          <th style="width: 20%;">æ¯äººç§¯åˆ†</th>
          <th style="width: 10%;">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="inviteRuleTableBody"></tbody>
      </table>
      <div id="inviteRuleEmptyTip" class="empty-tip">
        è¿˜æ²¡æœ‰é…ç½®é‚€è¯·è§„åˆ™ï¼Œå¯ä»¥å…ˆä¸ºã€Œè¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸã€æ·»åŠ  0â€“1ã€2â€“5ã€6â€“10 ç­‰åŒºé—´ã€‚
      </div>
    </div>
  </section>

  <!-- 4. æ¨¡æ‹Ÿè®¡ç®— -->
  <section class="section" id="calc-section">
    <h2>
      4. ç§¯åˆ†æ¨¡æ‹Ÿè®¡ç®—
      <span class="badge">ä½¿ç”¨æ¬¡æ•° â†’ å‰©ä½™ç§¯åˆ†</span>
    </h2>

    <div class="section-desc">
      ç¬¬ä¸€æ­¥ï¼šå¡«å†™æ¯ç§ã€Œèµšç§¯åˆ†ã€é€”å¾„çš„ä½¿ç”¨æ¬¡æ•°ï¼ˆä¸€æ¬¡æ€§å¥–åŠ±ç”¨â€œå·²å®Œæˆâ€ï¼‰ï¼Œç®—å‡ºæ€»å…±èµšäº†å¤šå°‘åˆ†ã€‚<br>
      ç¬¬äºŒæ­¥ï¼šå¡«å†™æ¯ç§ã€ŒèŠ±ç§¯åˆ†ã€é€”å¾„çš„ä½¿ç”¨æ¬¡æ•°ï¼Œçœ‹èŠ±æ‰å¤šå°‘åˆ†ã€‚<br>
      ç¬¬ä¸‰æ­¥ï¼šå¡«å†™é‚€è¯·ç³»ç»Ÿä¸­å„æ¡ä»¶çš„é‚€è¯·äººæ•°ï¼ŒæŒ‰é˜¶æ¢¯è§„åˆ™è‡ªåŠ¨ç®—å‡ºé‚€è¯·ç§¯åˆ†ã€‚
    </div>

    <div class="calc-columns">
      <div>
        <div class="calc-section-title">
          <strong>èµšç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¥æºåˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>

          <label class="tiny-switch" style="margin-left:auto;">
            <input type="checkbox" id="allOneTimeDoneSwitch" />
            æ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±å·²å®Œæˆ
          </label>
        </div>

        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡ç§¯åˆ†</th>
            <th>ä½¿ç”¨æ¬¡æ•° / çŠ¶æ€</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="earnCalcBody"></tbody>
        </table>
        <div id="earnCalcEmptyTip" class="empty-tip">æš‚æ— èµšç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€Œèµšç§¯åˆ†çš„é€”å¾„ã€ã€‚</div>

        <div style="margin-top: 16px;">
          <div class="calc-section-title">
            <strong>é‚€è¯·ç³»ç»Ÿç§¯åˆ†</strong>
            <span class="tag">æ ¹æ®é˜¶æ¢¯è§„åˆ™è‡ªåŠ¨è®¡ç®—</span>
          </div>
          <table>
            <thead>
            <tr>
              <th>è¢«é‚€è¯·äººæ¡ä»¶</th>
              <th>é‚€è¯·äººæ•°</th>
              <th>å°è®¡ç§¯åˆ†</th>
            </tr>
            </thead>
            <tbody id="inviteCalcBody"></tbody>
          </table>
          <div id="inviteCalcEmptyTip" class="empty-tip">
            å½“å‰å°šæœªä¸ºä»»æ„æ¡ä»¶é…ç½®é‚€è¯·è§„åˆ™ï¼Œå³ä½¿å¡«å†™äººæ•°ä¹Ÿä¸ä¼šäº§ç”Ÿç§¯åˆ†ã€‚
          </div>
        </div>
      </div>

      <div>
        <div class="calc-section-title">
          <strong>èŠ±ç§¯åˆ†æ¬¡æ•°</strong>
          <span class="tag">ä»ä¸Šé¢çš„æ¶ˆè€—åˆ—è¡¨è‡ªåŠ¨ç”Ÿæˆ</span>
        </div>

        <table>
          <thead>
          <tr>
            <th>é€”å¾„</th>
            <th>æ¯æ¬¡èŠ±è´¹</th>
            <th>ä½¿ç”¨æ¬¡æ•°</th>
            <th>å°è®¡</th>
          </tr>
          </thead>
          <tbody id="spendCalcBody"></tbody>
        </table>
        <div id="spendCalcEmptyTip" class="empty-tip">æš‚æ— èŠ±ç§¯åˆ†é…ç½®ï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹æ·»åŠ ã€ŒèŠ±ç§¯åˆ†çš„é€”å¾„ã€ã€‚</div>
      </div>
    </div>

    <div style="margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="calcButton" class="primary">ğŸ’° è®¡ç®—ç§¯åˆ†</button>
      <button id="resetCountsButton" class="secondary">æ¸…ç©ºæ‰€æœ‰æ¬¡æ•°</button>
    </div>

    <div class="result-box">
      <div class="result-row">
        <span class="result-label">æ€»å…±è·å¾—ç§¯åˆ†ï¼ˆå«é‚€è¯·ï¼‰ï¼š</span>
        <span class="result-value" id="totalEarned">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">æ€»å…±èŠ±è´¹ç§¯åˆ†ï¼š</span>
        <span class="result-value" id="totalSpent">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">å‰©ä½™ç§¯åˆ†ï¼š</span>
        <span class="result-value result-balance" id="balance">0</span>
      </div>
      <div class="result-row">
        <span class="result-label">æŒ‰ä¼˜å…ˆçº§æœ€å¤šå¯å…‘æ¢ï¼š</span>
        <span class="result-value" id="redeemSuggestion">â€”</span>
      </div>
    </div>

    

    <!-- âœ… æ–°å¢ï¼šè§„åˆ™ä¸‹å…‘æ¢é¢„æµ‹è¡¨ -->
    <div style="margin-top: 18px; border-top: 1px solid #e5e7eb; padding-top: 16px;">
      <h2 style="margin:0 0 10px; font-size:16px;">
        5. è§„åˆ™ä¸‹å…‘æ¢é¢„æµ‹è¡¨
        <span class="badge">n1~n2 å…¨é‡æšä¸¾</span>
      </h2>
      <div class="section-desc">
        é€‰æ‹©â€œå®Œæˆæ¡ä»¶â€ï¼ˆèµšç§¯åˆ†é€”å¾„å¯ä»¥é€‰å¤šä¸ªï¼Œå…¶ä¸­å¯é€‰æ‹©ã€Œå®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±ã€ï¼‰ï¼Œå†è®¾ç½®é‚€è¯·äººæ•°èŒƒå›´ n1ï½n2ï¼Œå¹¶é€‰æ‹©è‹¥å¹²è¢«é‚€è¯·äººæ¡ä»¶ï¼ˆå¯åŠ å¤šæ¡ï¼‰ã€‚ç³»ç»Ÿä¼šè¾“å‡ºæ¯ä¸ª n çš„å¯å…‘æ¢ç»“æœä¸â€œè·ç¦»ä¸‹ä¸€æ¡£ä½â€ã€‚
      </div>

      <div class="mini-grid">
        <div>
          <div class="pill" style="margin-bottom:10px;">
            <strong>å®Œæˆå“ªäº›èµšç§¯åˆ†é€”å¾„</strong>
            <span class="muted">ï¼ˆæ¯æ¡é»˜è®¤æŒ‰å®Œæˆ 1 æ¬¡è®¡åˆ†ï¼‰</span>
          </div>

          <div class="check-list" id="scenarioEarnChecklist"></div>
          <div class="empty-tip" id="scenarioEarnEmptyTip" style="display:none;">
            æš‚æ— èµšç§¯åˆ†é…ç½®ã€‚
          </div>
        </div>

        <div>
          <div class="pill" style="margin-bottom:10px;">
            <strong>é‚€è¯·äººæ•°èŒƒå›´</strong>
          </div>

          <div class="inline-form" style="margin-bottom:8px;">
            <input type="number" id="scenarioN1" min="0" step="1" value="0" placeholder="æ•°å­—1" />
            <span class="muted">åˆ°</span>
            <input type="number" id="scenarioN2" min="0" step="1" value="10" placeholder="æ•°å­—2" />
            <span class="muted">äºº</span>
          </div>

          <div class="pill" style="margin-bottom:10px;">
            <strong>è¢«é‚€è¯·äººæ¡ä»¶ï¼ˆå¯æ·»åŠ ï¼‰</strong>
            <span class="muted">ï¼ˆåŒä¸€ä¸ª n å¯¹æ¯ä¸ªæ¡ä»¶åˆ†åˆ«è®¡ç®—å¹¶ç´¯åŠ ï¼‰</span>
          </div>

          <div id="scenarioConditionRows" style="display:grid; gap:8px;"></div>

          <div class="row-actions" style="margin-top:10px;">
            <button id="scenarioAddCondBtn" class="secondary">+ æ·»åŠ æ¡ä»¶</button>
            <button id="scenarioGenBtn" class="primary">ç”Ÿæˆè¡¨æ ¼</button>
          </div>
        </div>
      </div>

      <div style="margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="scenarioCopyBtn" class="secondary" disabled>ğŸ“‹ å¤åˆ¶è¡¨æ ¼å†…å®¹</button>
        <button id="scenarioExportBtn" class="secondary" disabled>ğŸ“‘ å¯¼å‡ºè¡¨æ ¼ä¸º Excel</button>
      </div>

      <table id="scenarioTable" style="margin-top:10px;">
        <thead>
        <tr>
          <th style="width: 45%;">å®Œæˆæ¡ä»¶</th>
          <th style="width: 30%;">å¯å…‘æ¢å¥–åŠ±</th>
          <th style="width: 25%;">è·ç¦»ä¸‹ä¸€æ¡£ä½</th>
        </tr>
        </thead>
        <tbody id="scenarioTableBody"></tbody>
      </table>
      <div id="scenarioEmptyTip" class="empty-tip">
        è¿˜æ²¡ç”Ÿæˆè¡¨æ ¼ã€‚ä½ å¯ä»¥å…ˆç‚¹ã€Œæ·»åŠ æ¡ä»¶ã€é€‰ä¸¤æ¡ï¼Œå†ç”Ÿæˆçœ‹çœ‹ã€‚
      </div>
    </div>

  </section>
</div>

<script>
  const STORAGE_KEY = "points-config-v2";

  const REDEEM_PRIORITY = [
    "å…‘æ¢1å¹´ä¼šå‘˜",
    "å…‘æ¢6ä¸ªæœˆä¼šå‘˜",
    "å…‘æ¢3ä¸ªæœˆä¼šå‘˜",
    "å…‘æ¢1ä¸ªæœˆä¼šå‘˜",
    "å…‘æ¢1å‘¨ä¼šå‘˜",
    "å…‘æ¢3å¤©ä¼šå‘˜",
    "å…‘æ¢1å¤©ä¼šå‘˜"
  ];

  // ===== æ•°æ® =====
  let earnActions = [];   // {id, name, points, oneTime}
  let spendActions = [];  // {id, name, points}
  let inviteRules = [];   // {id, condition, min, max, points}
  let nextId = 1;

  // ===== DOM =====
  const earnTableBody = document.getElementById("earnTableBody");
  const spendTableBody = document.getElementById("spendTableBody");
  const earnEmptyTip = document.getElementById("earnEmptyTip");
  const spendEmptyTip = document.getElementById("spendEmptyTip");

  const inviteRuleTableBody = document.getElementById("inviteRuleTableBody");
  const inviteRuleEmptyTip = document.getElementById("inviteRuleEmptyTip");

  const earnCalcBody = document.getElementById("earnCalcBody");
  const spendCalcBody = document.getElementById("spendCalcBody");
  const earnCalcEmptyTip = document.getElementById("earnCalcEmptyTip");
  const spendCalcEmptyTip = document.getElementById("spendCalcEmptyTip");

  const inviteCalcBody = document.getElementById("inviteCalcBody");
  const inviteCalcEmptyTip = document.getElementById("inviteCalcEmptyTip");

  const totalEarnedSpan = document.getElementById("totalEarned");
  const totalSpentSpan = document.getElementById("totalSpent");
  const balanceSpan = document.getElementById("balance");
  const redeemSuggestionSpan = document.getElementById("redeemSuggestion");

  const allOneTimeDoneSwitch = document.getElementById("allOneTimeDoneSwitch");

  // ===== æ–°å¢æ¨¡å— DOM =====
  const scenarioEarnChecklist = document.getElementById("scenarioEarnChecklist");
  const scenarioEarnEmptyTip = document.getElementById("scenarioEarnEmptyTip");
  const scenarioN1 = document.getElementById("scenarioN1");
  const scenarioN2 = document.getElementById("scenarioN2");
  const scenarioConditionRows = document.getElementById("scenarioConditionRows");
  const scenarioAddCondBtn = document.getElementById("scenarioAddCondBtn");
  const scenarioGenBtn = document.getElementById("scenarioGenBtn");
  const scenarioCopyBtn = document.getElementById("scenarioCopyBtn");
  const scenarioExportBtn = document.getElementById("scenarioExportBtn");
  const scenarioTableBody = document.getElementById("scenarioTableBody");
  const scenarioEmptyTip = document.getElementById("scenarioEmptyTip");

  // å†…éƒ¨çŠ¶æ€ï¼šæ¡ä»¶è¡Œ
  let scenarioCondRowIds = []; // array of numeric ids
  let scenarioCondNextId = 1;

  // ====== utils ======
  function recomputeNextId() {
    const all = [...earnActions, ...spendActions, ...inviteRules];
    nextId = all.length ? (Math.max(...all.map(a => a.id || 0)) + 1) : 1;
  }

  function uniqInviteConditions() {
    return [...new Set(inviteRules.map(r => (r.condition || "").trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"zh-CN"));
  }

  // ===== Earn list =====
  function renderEarnActions() {
    earnTableBody.innerHTML = "";
    earnEmptyTip.style.display = earnActions.length ? "none" : "block";

    earnActions.forEach(action => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      const pointsTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = action.points ?? 0;
      input.style.width = "80px";
      input.addEventListener("change", () => {
        const val = Number(input.value);
        action.points = (Number.isFinite(val) && val >= 0) ? val : 0;
        input.value = action.points;
        renderCalcTables();
        renderScenarioPanel(); // âœ… åŒæ­¥åˆ·æ–°é¢„æµ‹æ¨¡å—
      });
      pointsTd.appendChild(input);
      pointsTd.appendChild(Object.assign(document.createElement("span"), { textContent: " åˆ†", style: "margin-left:4px;" }));
      tr.appendChild(pointsTd);

      const oneTimeTd = document.createElement("td");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!action.oneTime;
      cb.addEventListener("change", () => {
        action.oneTime = cb.checked;
        renderCalcTables();
        renderScenarioPanel(); // âœ… åŒæ­¥åˆ·æ–°é¢„æµ‹æ¨¡å—
      });
      oneTimeTd.appendChild(cb);
      oneTimeTd.appendChild(Object.assign(document.createElement("span"), { textContent: " æ˜¯" }));
      tr.appendChild(oneTimeTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        earnActions = earnActions.filter(a => a.id !== action.id);
        renderEarnActions();
        renderCalcTables();
        renderScenarioPanel(); // âœ…
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      earnTableBody.appendChild(tr);
    });
  }

  function renderSpendActions() {
    spendTableBody.innerHTML = "";
    spendEmptyTip.style.display = spendActions.length ? "none" : "block";

    spendActions.forEach(action => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = action.name;
      tr.appendChild(nameTd);

      const pointsTd = document.createElement("td");
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = action.points ?? 0;
      input.style.width = "80px";
      input.addEventListener("change", () => {
        const val = Number(input.value);
        action.points = (Number.isFinite(val) && val >= 0) ? val : 0;
        input.value = action.points;
        renderCalcTables();
        // å…‘æ¢é€»è¾‘ä¾èµ– spendActionsï¼Œé¢„æµ‹æ¨¡å—ä¹Ÿè¦åŒæ­¥
      });
      pointsTd.appendChild(input);
      pointsTd.appendChild(Object.assign(document.createElement("span"), { textContent: " åˆ†", style: "margin-left:4px;" }));
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ é™¤";
      delBtn.className = "danger";
      delBtn.addEventListener("click", () => {
        spendActions = spendActions.filter(a => a.id !== action.id);
        renderSpendActions();
        renderCalcTables();
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      spendTableBody.appendChild(tr);
    });
  }

  function renderInviteRules() {
    inviteRuleTableBody.innerHTML = "";
    inviteRuleEmptyTip.style.display = inviteRules.length ? "none" : "block";

    const sorted = [...inviteRules].sort((a, b) => {
      const ac = (a.condition || "").trim();
      const bc = (b.condition || "").trim();
      if (ac === bc) return (a.min - b.min) || (a.max - b.max);
      return ac.localeCompare(bc, "zh-CN");
    });

    sorted.forEach(rule => {
      const tr = document.createElement("tr");

      const condTd = document.createElement("td");
      condTd.textContent = rule.condition;
      tr.appendChild(condTd);

      const rangeTd = document.createElement("td");
      rangeTd.textContent = `${rule.min} ï½ ${rule.max} äºº`;
      tr.appendChild(rangeTd);

      const pointsTd = document.createElement("td");
      pointsTd.textContent = rule.points + " åˆ†/äºº";
      tr.appendChild(pointsTd);

      const opTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.textContent = "åˆ ";
      delBtn.className = "danger";
      delBtn.style.padding = "4px 8px";
      delBtn.addEventListener("click", () => {
        inviteRules = inviteRules.filter(r => r.id !== rule.id);
        renderInviteRules();
        renderCalcTables();
        renderScenarioPanel(); // âœ… æ¡ä»¶ä¸‹æ‹‰è¦åˆ·æ–°
      });
      opTd.appendChild(delBtn);
      tr.appendChild(opTd);

      inviteRuleTableBody.appendChild(tr);
    });
  }

  // ===== Invite calc =====
  function calcInvitePointsForCondition(condition, totalInvites) {
    const rules = inviteRules.filter(r => r.condition === condition);
    if (!rules.length || totalInvites <= 0) return 0;

    const sorted = [...rules].sort((a, b) => a.min - b.min || a.max - b.max);
    let total = 0;

    sorted.forEach(rule => {
      const start = Math.max(rule.min, 1);
      if (totalInvites < start) return;
      const end = Math.min(rule.max, totalInvites);
      if (end < start) return;
      total += (end - start + 1) * rule.points;
    });

    return total;
  }

  // ===== Redeem (å¸¦â€œå‰©ä½™â€è¾“å‡º) =====
  function redeemGreedy(balance) {
    let remaining = balance;
    const picked = [];

    REDEEM_PRIORITY.forEach(name => {
      const action = spendActions.find(a => a.name === name);
      if (!action || !action.points || action.points <= 0) return;

      const cnt = Math.floor(remaining / action.points);
      if (cnt > 0) {
        picked.push({ name: name.replace(/^å…‘æ¢/, ""), count: cnt, cost: action.points });
        remaining -= cnt * action.points;
      }
    });

    return { picked, remaining };
  }

  function getRedeemSuggestion(balance) {
    if (balance <= 0) return "å½“å‰ç§¯åˆ†ä¸º 0ï¼Œæ— æ³•å…‘æ¢ã€‚";
    const { picked } = redeemGreedy(balance);
    if (!picked.length) return "å½“å‰ç§¯åˆ†ä¸è¶³ä»¥å…‘æ¢ä»»ä½•ä¼šå‘˜æ¡£ä½ã€‚";
    return picked.map(x => x.count === 1 ? x.name : `${x.name}*${x.count}`).join(" + ");
  }

  function getNextTierGapText(remaining) {
    // æ‰¾åˆ°â€œå†å…‘æ¢ 1 ä¸ªä»»æ„æ¡£ä½â€æ‰€éœ€çš„æœ€å°å·®å€¼
    let best = null; // {gap, name}
    REDEEM_PRIORITY.forEach(name => {
      const action = spendActions.find(a => a.name === name);
      if (!action || !action.points || action.points <= 0) return;
      const cost = action.points;
      if (remaining >= cost) return; // èƒ½å…‘å°±ä¸ä¼šâ€œå·®â€
      const gap = cost - remaining;
      if (best === null || gap < best.gap) {
        best = { gap, name: name.replace(/^å…‘æ¢/, "") };
      }
    });
    if (!best) return "â€”";
    return `è¿˜å·® ${best.gap} ç§¯åˆ†å¯ä»¥å†å…‘æ¢ ${best.name}`;
  }

  // ===== æ¸²æŸ“æ¨¡æ‹ŸåŒº =====
  function renderCalcTables() {
    // Earn
    earnCalcBody.innerHTML = "";
    if (!earnActions.length) {
      earnCalcEmptyTip.style.display = "block";
    } else {
      earnCalcEmptyTip.style.display = "none";
      earnActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points ?? 0;
        tr.appendChild(pointsTd);

        const usageTd = document.createElement("td");

        if (action.oneTime) {
          const wrap = document.createElement("label");
          wrap.className = "tiny-switch";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "earn-onetime-done";
          cb.dataset.actionId = action.id;

          const allDone = !!allOneTimeDoneSwitch.checked;
          cb.checked = allDone ? true : false;
          cb.disabled = allDone;

          const txt = document.createElement("span");
          txt.textContent = allDone ? "å·²å®Œæˆï¼ˆç”±æ€»å¼€å…³æ§åˆ¶ï¼‰" : "å·²å®Œæˆ";
          if (allDone) txt.classList.add("muted");

          wrap.appendChild(cb);
          wrap.appendChild(txt);
          usageTd.appendChild(wrap);
        } else {
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0";
          input.step = "1";
          input.value = "0";
          input.dataset.actionId = action.id;
          input.className = "earn-count-input";
          input.style.width = "80px";
          usageTd.appendChild(input);
        }

        tr.appendChild(usageTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.actionId = action.id;
        subtotalTd.className = "earn-subtotal";
        tr.appendChild(subtotalTd);

        earnCalcBody.appendChild(tr);
      });
    }

    // Spend
    spendCalcBody.innerHTML = "";
    if (!spendActions.length) {
      spendCalcEmptyTip.style.display = "block";
    } else {
      spendCalcEmptyTip.style.display = "none";
      spendActions.forEach(action => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = action.name;
        tr.appendChild(nameTd);

        const pointsTd = document.createElement("td");
        pointsTd.textContent = action.points ?? 0;
        tr.appendChild(pointsTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.dataset.actionId = action.id;
        input.className = "spend-count-input";
        input.style.width = "80px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.actionId = action.id;
        subtotalTd.className = "spend-subtotal";
        tr.appendChild(subtotalTd);

        spendCalcBody.appendChild(tr);
      });
    }

    // Invite
    inviteCalcBody.innerHTML = "";
    const conditions = uniqInviteConditions();
    if (!conditions.length) {
      inviteCalcEmptyTip.style.display = "block";
    } else {
      inviteCalcEmptyTip.style.display = "none";
      conditions.forEach(cond => {
        const tr = document.createElement("tr");

        const condTd = document.createElement("td");
        condTd.textContent = cond;
        tr.appendChild(condTd);

        const countTd = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.dataset.condition = cond;
        input.className = "invite-count-input";
        input.style.width = "80px";
        countTd.appendChild(input);
        tr.appendChild(countTd);

        const subtotalTd = document.createElement("td");
        subtotalTd.textContent = "0";
        subtotalTd.dataset.condition = cond;
        subtotalTd.className = "invite-subtotal";
        tr.appendChild(subtotalTd);

        inviteCalcBody.appendChild(tr);
      });
    }
  }

  // ===== è®¡ç®—æ¨¡æ‹Ÿ =====
  function calculatePoints() {
    let totalEarned = 0;
    let totalSpent = 0;

    document.querySelectorAll(".earn-count-input").forEach(input => {
      const id = parseInt(input.dataset.actionId, 10);
      const action = earnActions.find(a => a.id === id);
      if (!action) return;

      let count = Number(input.value) || 0;
      if (count < 0) count = 0;
      input.value = String(count);

      const subtotal = count * (action.points || 0);
      totalEarned += subtotal;

      const td = document.querySelector('.earn-subtotal[data-action-id="' + id + '"]');
      if (td) td.textContent = subtotal;
    });

    const allDone = !!allOneTimeDoneSwitch.checked;
    document.querySelectorAll(".earn-onetime-done").forEach(cb => {
      const id = parseInt(cb.dataset.actionId, 10);
      const action = earnActions.find(a => a.id === id);
      if (!action) return;

      const done = allDone ? true : !!cb.checked;
      const subtotal = done ? (action.points || 0) : 0;
      totalEarned += subtotal;

      const td = document.querySelector('.earn-subtotal[data-action-id="' + id + '"]');
      if (td) td.textContent = subtotal;
    });

    document.querySelectorAll(".spend-count-input").forEach(input => {
      const id = parseInt(input.dataset.actionId, 10);
      const action = spendActions.find(a => a.id === id);
      if (!action) return;

      let count = Number(input.value) || 0;
      if (count < 0) count = 0;
      input.value = String(count);

      const subtotal = count * (action.points || 0);
      totalSpent += subtotal;

      const td = document.querySelector('.spend-subtotal[data-action-id="' + id + '"]');
      if (td) td.textContent = subtotal;
    });

    document.querySelectorAll(".invite-count-input").forEach(input => {
      const cond = input.dataset.condition;
      let count = Number(input.value) || 0;
      if (count < 0) count = 0;
      input.value = String(count);

      const subtotal = calcInvitePointsForCondition(cond, count);
      totalEarned += subtotal;

      const td = document.querySelector('.invite-subtotal[data-condition="' + cond + '"]');
      if (td) td.textContent = subtotal;
    });

    const balance = totalEarned - totalSpent;
    totalEarnedSpan.textContent = totalEarned;
    totalSpentSpan.textContent = totalSpent;

    balanceSpan.textContent = balance;
    balanceSpan.classList.remove("positive", "negative");
    if (balance > 0) balanceSpan.classList.add("positive");
    else if (balance < 0) balanceSpan.classList.add("negative");

    redeemSuggestionSpan.textContent = getRedeemSuggestion(balance);
  }

  function resetAllCounts() {
    document.querySelectorAll(".earn-count-input, .spend-count-input, .invite-count-input")
      .forEach(input => input.value = "0");

    document.querySelectorAll(".earn-onetime-done").forEach(cb => cb.checked = false);

    allOneTimeDoneSwitch.checked = false;
    renderCalcTables();

    document.querySelectorAll(".earn-subtotal, .spend-subtotal, .invite-subtotal")
      .forEach(td => td.textContent = "0");

    totalEarnedSpan.textContent = "0";
    totalSpentSpan.textContent = "0";
    balanceSpan.textContent = "0";
    balanceSpan.classList.remove("positive", "negative");
    redeemSuggestionSpan.textContent = "â€”";
  }

  // ===== æœ¬åœ°ä¿å­˜/è½½å…¥ =====
  function saveConfig() {
    const data = { earnActions, spendActions, inviteRules };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert("å·²ä¿å­˜åˆ°æœ¬æµè§ˆå™¨ï¼ˆåŒä¸€å°è®¾å¤‡ã€åŒä¸€æµè§ˆå™¨ä¸‹ä¼šä¿ç•™ï¼‰");
    } catch (e) {
      console.error(e);
      alert("ä¿å­˜å¤±è´¥ï¼šå¯èƒ½æ˜¯æµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨ã€‚");
    }
  }

  function loadConfig(showAlert = true) {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      if (showAlert) alert("æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return false;
    }
    try {
      const data = JSON.parse(raw);
      earnActions = Array.isArray(data.earnActions) ? data.earnActions : [];
      earnActions = earnActions.map(a => ({ ...a, oneTime: !!a.oneTime }));

      spendActions = Array.isArray(data.spendActions) ? data.spendActions : [];
      inviteRules = Array.isArray(data.inviteRules) ? data.inviteRules : [];

      recomputeNextId();

      renderEarnActions();
      renderSpendActions();
      renderInviteRules();
      renderCalcTables();

      allOneTimeDoneSwitch.checked = false;
      resetAllCounts();

      renderScenarioPanel(); // âœ…

      if (showAlert) alert("å·²è½½å…¥æœ¬åœ°ä¿å­˜çš„ç§¯åˆ†è§„åˆ™ã€‚");
      return true;
    } catch (e) {
      console.error(e);
      if (showAlert) alert("ä¿å­˜çš„æ•°æ®å·²æŸåï¼Œæ— æ³•è¯»å–ã€‚");
      return false;
    }
  }

  function clearConfig() {
    localStorage.removeItem(STORAGE_KEY);
    alert("å·²æ¸…é™¤æœ¬åœ°ä¿å­˜ã€‚å½“å‰é¡µé¢ä¸Šçš„è§„åˆ™ä¸ä¼šè‡ªåŠ¨æ¸…ç©ºï¼Œå¦‚éœ€é‡ç½®è¯·æ‰‹åŠ¨ä¿®æ”¹æˆ–å¯¼å…¥å…¶ä»–æ–¹æ¡ˆã€‚");
  }

  // ===== Excel å¯¼å‡º/å¯¼å…¥è§„åˆ™ =====
  function exportConfigToXlsx() {
    if (typeof XLSX === "undefined") {
      alert("å½“å‰ç¯å¢ƒæ— æ³•ä½¿ç”¨ Excel å¯¼å‡ºåŠŸèƒ½ã€‚");
      return;
    }
    const wb = XLSX.utils.book_new();

    const earnData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†", "æ˜¯å¦ä¸€æ¬¡æ€§å¥–åŠ±"]];
    earnActions.forEach(a => earnData.push(["èµšç§¯åˆ†", a.name, a.points, a.oneTime ? "æ˜¯" : "å¦"]));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(earnData), "EarnRules");

    const spendData = [["ç±»å‹", "é€”å¾„åç§°", "æ¯æ¬¡ç§¯åˆ†"]];
    spendActions.forEach(a => spendData.push(["èŠ±ç§¯åˆ†", a.name, a.points]));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(spendData), "SpendRules");

    const inviteData = [["è¢«é‚€è¯·äººæ¡ä»¶", "èµ·å§‹äººæ•°", "ç»“æŸäººæ•°", "æ¯äººç§¯åˆ†"]];
    inviteRules.forEach(r => inviteData.push([r.condition, r.min, r.max, r.points]));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(inviteData), "InviteRules");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    XLSX.writeFile(wb, `ç§¯åˆ†è§„åˆ™_${y}${m}${d}.xlsx`);
  }

  function getByAliases(row, aliases) {
    const keys = Object.keys(row || {});
    for (const a of aliases) {
      const hit = keys.find(k => String(k).trim() === a);
      if (hit !== undefined) return row[hit];
    }
    return undefined;
  }
  function toNum(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function toBoolCN(v) {
    const s = String(v ?? "").trim();
    return ["æ˜¯", "true", "TRUE", "1", "Yes", "YES"].includes(s);
  }

  function importConfigFromXlsx(file) {
    if (!file) return;
    const reader = new FileReader();

    reader.onload = function (e) {
      try {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: "array" });

        const earnSheet = workbook.Sheets["EarnRules"];
        const spendSheet = workbook.Sheets["SpendRules"];
        const inviteSheet = workbook.Sheets["InviteRules"];

        if (!earnSheet || !spendSheet) {
          alert("Excel æ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å« EarnRules å’Œ SpendRules ä¸¤ä¸ª Sheetã€‚");
          return;
        }

        const earnJson = XLSX.utils.sheet_to_json(earnSheet, { defval: "" });
        const spendJson = XLSX.utils.sheet_to_json(spendSheet, { defval: "" });

        earnActions = earnJson
          .map((row, idx) => ({
            id: idx + 1,
            name: String(getByAliases(row, ["é€”å¾„åç§°"]) ?? "").trim(),
            points: toNum(getByAliases(row, ["æ¯æ¬¡ç§¯åˆ†"])),
            oneTime: toBoolCN(getByAliases(row, ["æ˜¯å¦ä¸€æ¬¡æ€§å¥–åŠ±"]))
          }))
          .filter(r => r.name);

        const base = earnActions.length + 1;

        spendActions = spendJson
          .map((row, idx) => ({
            id: base + idx,
            name: String(getByAliases(row, ["é€”å¾„åç§°"]) ?? "").trim(),
            points: toNum(getByAliases(row, ["æ¯æ¬¡ç§¯åˆ†"]))
          }))
          .filter(r => r.name);

        const inviteBase = base + spendActions.length;

        if (inviteSheet) {
          const inviteJson = XLSX.utils.sheet_to_json(inviteSheet, { defval: "" });
          inviteRules = inviteJson
            .map((row, idx) => ({
              id: inviteBase + idx,
              condition: String(getByAliases(row, ["è¢«é‚€è¯·äººæ¡ä»¶"]) ?? "").trim(),
              min: toNum(getByAliases(row, ["èµ·å§‹äººæ•°"])),
              max: toNum(getByAliases(row, ["ç»“æŸäººæ•°"])),
              points: toNum(getByAliases(row, ["æ¯äººç§¯åˆ†"]))
            }))
            .filter(r => r.condition);
        } else {
          inviteRules = [];
        }

        recomputeNextId();
        renderEarnActions();
        renderSpendActions();
        renderInviteRules();

        allOneTimeDoneSwitch.checked = false;
        renderCalcTables();
        resetAllCounts();

        renderScenarioPanel(); // âœ…

        alert("å·²æˆåŠŸä» Excel å¯¼å…¥è§„åˆ™ï¼");
      } catch (err) {
        console.error(err);
        alert("Excel æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥å­—æ®µåæ˜¯å¦æ­£ç¡®ã€‚");
      }
    };

    reader.readAsArrayBuffer(file);
  }

  // =========================
  // âœ… æ–°å¢ï¼šå…‘æ¢é¢„æµ‹è¡¨æ¨¡å—
  // =========================

  function renderScenarioPanel() {
    // 1) Earn checklist
    scenarioEarnChecklist.innerHTML = "";
    if (!earnActions.length) {
      scenarioEarnEmptyTip.style.display = "block";
    } else {
      scenarioEarnEmptyTip.style.display = "none";

      // ç‰¹æ®Šé¡¹ï¼šå®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±
      const special = document.createElement("label");
      special.className = "check-item";
      special.innerHTML = `
        <input type="checkbox" id="scenarioAllOneTime" />
        <div>
          <div><strong>å®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±</strong></div>
          <div class="sub">æŠŠæ‰€æœ‰æ ‡è®°ä¸ºâ€œä¸€æ¬¡æ€§â€çš„èµšåˆ†é€”å¾„éƒ½ç®—ä¸Šï¼ˆæ¯æ¡ç®— 1 æ¬¡ï¼‰</div>
        </div>
      `;
      scenarioEarnChecklist.appendChild(special);

      earnActions.forEach(a => {
        const item = document.createElement("label");
        item.className = "check-item";
        item.innerHTML = `
          <input type="checkbox" class="scenario-earn-item" data-action-id="${a.id}" />
          <div>
            <div>${a.name} <span class="muted">ï¼ˆ+${a.points || 0}ï¼‰</span> ${a.oneTime ? `<span class="tag">ä¸€æ¬¡æ€§</span>` : ``}</div>
            <div class="sub">é€‰ä¸­è¡¨ç¤ºâ€œå®Œæˆ 1 æ¬¡â€è®¡åˆ†</div>
          </div>
        `;
        scenarioEarnChecklist.appendChild(item);
      });
    }

    // 2) Condition rows
    if (scenarioCondRowIds.length === 0) {
      addScenarioCondRow(); // é»˜è®¤è‡³å°‘ä¸€è¡Œ
    } else {
      // åªæ˜¯åˆ·æ–°ä¸‹æ‹‰é€‰é¡¹
      scenarioCondRowIds.forEach(id => refreshScenarioCondRowSelect(id));
    }
  }

  function addScenarioCondRow() {
    const id = scenarioCondNextId++;
    scenarioCondRowIds.push(id);

    const row = document.createElement("div");
    row.id = `scenarioCondRow_${id}`;
    row.style.display = "flex";
    row.style.gap = "8px";
    row.style.flexWrap = "wrap";
    row.style.alignItems = "center";

    const select = document.createElement("select");
    select.id = `scenarioCondSelect_${id}`;
    select.style.minWidth = "220px";

    const del = document.createElement("button");
    del.className = "danger";
    del.textContent = "åˆ é™¤";
    del.addEventListener("click", () => {
      scenarioCondRowIds = scenarioCondRowIds.filter(x => x !== id);
      const el = document.getElementById(`scenarioCondRow_${id}`);
      if (el) el.remove();
      if (scenarioCondRowIds.length === 0) addScenarioCondRow();
    });

    row.appendChild(select);
    row.appendChild(del);
    scenarioConditionRows.appendChild(row);

    refreshScenarioCondRowSelect(id);
  }

  function refreshScenarioCondRowSelect(id) {
    const sel = document.getElementById(`scenarioCondSelect_${id}`);
    if (!sel) return;

    const conditions = uniqInviteConditions();
    const current = sel.value;

    sel.innerHTML = "";

    if (!conditions.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ï¼ˆæš‚æ— é‚€è¯·æ¡ä»¶ï¼Œè¯·å…ˆé…ç½®é‚€è¯·è§„åˆ™ï¼‰";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }

    sel.disabled = false;
    conditions.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });

    if (current && conditions.includes(current)) sel.value = current;
  }

  function getScenarioSelectedEarnActionIds() {
    return [...document.querySelectorAll(".scenario-earn-item:checked")]
      .map(cb => parseInt(cb.dataset.actionId, 10))
      .filter(n => Number.isFinite(n));
  }

  function getScenarioSelectedConditions() {
    const vals = scenarioCondRowIds
      .map(id => {
        const sel = document.getElementById(`scenarioCondSelect_${id}`);
        return sel ? String(sel.value || "").trim() : "";
      })
      .filter(Boolean);

    // æ¡ä»¶å…è®¸é‡å¤å—ï¼Ÿè¿™é‡Œé»˜è®¤å»é‡ï¼Œé¿å…åŒä¸€ä¸ªæ¡ä»¶é‡å¤åŠ åˆ†
    return [...new Set(vals)];
  }

  function buildScenarioDoneText(earnParts, n, conds) {
    const left = earnParts.length ? `å®Œæˆï¼š${earnParts.join("ã€")}` : "å®Œæˆï¼šæ— ";
    const right = conds.length
      ? `ï¼›å¹¶é‚€è¯· ${n} äººå®Œæˆï¼š${conds.join(" + ")}`
      : `ï¼›å¹¶é‚€è¯· ${n} äººï¼ˆæ— æ¡ä»¶ï¼‰`;
    return left + right;
  }

  function generateScenarioTable() {
    const n1 = Math.max(0, Math.floor(Number(scenarioN1.value) || 0));
    const n2 = Math.max(0, Math.floor(Number(scenarioN2.value) || 0));
    const start = Math.min(n1, n2);
    const end = Math.max(n1, n2);

    // èµšåˆ†é€‰æ‹©
    const allOneTime = !!document.getElementById("scenarioAllOneTime")?.checked;
    const selectedIds = new Set(getScenarioSelectedEarnActionIds());

    // è¢«é‚€è¯·æ¡ä»¶
    const conds = getScenarioSelectedConditions();

    // ç”Ÿæˆè¡¨æ ¼
    scenarioTableBody.innerHTML = "";
    scenarioEmptyTip.style.display = "none";

    const rows = [];

    for (let n = start; n <= end; n++) {
      let points = 0;
      const earnParts = [];

      // å®Œæˆæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±
      if (allOneTime) {
        const oneTimes = earnActions.filter(a => !!a.oneTime);
        if (oneTimes.length) {
          earnParts.push("æ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±");
          oneTimes.forEach(a => points += (a.points || 0));
        }
      }

      // å•ç‹¬é€‰ä¸­çš„èµšåˆ†é€”å¾„ï¼ˆæ¯æ¡ç®— 1 æ¬¡ï¼‰
      earnActions.forEach(a => {
        if (selectedIds.has(a.id)) {
          // é¿å…å’Œâ€œæ‰€æœ‰ä¸€æ¬¡æ€§å¥–åŠ±â€é‡å¤å åŠ ï¼šå¦‚æœå®ƒæ˜¯ä¸€æ¬¡æ€§ä¸”æ€»å¼€å…³å·²é€‰ï¼Œåˆ™ä¸å†åŠ ä¸€æ¬¡
          if (allOneTime && a.oneTime) return;
          earnParts.push(a.name);
          points += (a.points || 0);
        }
      });

      // é‚€è¯·ç§¯åˆ†ï¼šæ¯ä¸ªæ¡ä»¶éƒ½ç”¨åŒä¸€ä¸ª n è®¡ç®—å¹¶ç´¯åŠ 
      conds.forEach(c => {
        points += calcInvitePointsForCondition(c, n);
      });

      const redeemText = getRedeemSuggestion(points);

      const { remaining } = redeemGreedy(points);
      const gapText = getNextTierGapText(remaining);

      const doneText = buildScenarioDoneText(earnParts, n, conds);

      rows.push({
        done: doneText,
        redeem: redeemText,
        gap: gapText
      });
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.textContent = r.done;

      const td2 = document.createElement("td");
      td2.textContent = r.redeem;

      const td3 = document.createElement("td");
      td3.textContent = r.gap;

      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);

      scenarioTableBody.appendChild(tr);
    });

    // å¯ç”¨æŒ‰é’®
    scenarioCopyBtn.disabled = rows.length === 0;
    scenarioExportBtn.disabled = rows.length === 0;

    // æŠŠ rows å­˜èµ·æ¥ï¼ˆä¾›å¤åˆ¶/å¯¼å‡ºï¼‰
    window.__scenarioRows = rows;
  }

  function copyScenarioTable() {
    const rows = window.__scenarioRows || [];
    if (!rows.length) return;

    // TSVï¼šå¤åˆ¶åç²˜åˆ° Excel ä¼šè‡ªåŠ¨åˆ†åˆ—
    const header = ["å®Œæˆæ¡ä»¶", "å¯å…‘æ¢å¥–åŠ±", "è·ç¦»ä¸‹ä¸€æ¡£ä½"];
    const lines = [header.join("\t")];
    rows.forEach(r => {
      lines.push([r.done, r.redeem, r.gap].join("\t"));
    });
    const text = lines.join("\n");

    navigator.clipboard.writeText(text)
      .then(() => alert("å·²å¤åˆ¶ï¼ç›´æ¥ç²˜è´´åˆ° Excel/é£ä¹¦è¡¨æ ¼å³å¯è‡ªåŠ¨åˆ†åˆ—ã€‚"))
      .catch(() => alert("å¤åˆ¶å¤±è´¥ï¼šå½“å‰æµè§ˆå™¨å¯èƒ½ç¦æ­¢å‰ªè´´æ¿æƒé™ã€‚"));
  }

  function exportScenarioTableToXlsx() {
    const rows = window.__scenarioRows || [];
    if (!rows.length) return;

    if (typeof XLSX === "undefined") {
      alert("å½“å‰ç¯å¢ƒæ— æ³•ä½¿ç”¨ Excel å¯¼å‡ºåŠŸèƒ½ã€‚");
      return;
    }

    const wb = XLSX.utils.book_new();
    const aoa = [["å®Œæˆæ¡ä»¶", "å¯å…‘æ¢å¥–åŠ±", "è·ç¦»ä¸‹ä¸€æ¡£ä½"]];
    rows.forEach(r => aoa.push([r.done, r.redeem, r.gap]));
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, "RedeemTable");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    XLSX.writeFile(wb, `å…‘æ¢é¢„æµ‹è¡¨_${y}${m}${d}.xlsx`);
  }

  // ===== äº‹ä»¶ç»‘å®š =====
  document.getElementById("addEarnForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("earnName").value.trim();
    const pointsVal = Number(document.getElementById("earnPoints").value);
    if (!name || !Number.isFinite(pointsVal) || pointsVal < 0) return;

    earnActions.push({ id: nextId++, name, points: pointsVal, oneTime: false });
    document.getElementById("earnName").value = "";
    document.getElementById("earnPoints").value = "";

    renderEarnActions();
    renderCalcTables();
    renderScenarioPanel();
  });

  document.getElementById("addSpendForm").addEventListener("submit", e => {
    e.preventDefault();
    const name = document.getElementById("spendName").value.trim();
    const pointsVal = Number(document.getElementById("spendPoints").value);
    if (!name || !Number.isFinite(pointsVal) || pointsVal < 0) return;

    spendActions.push({ id: nextId++, name, points: pointsVal });
    document.getElementById("spendName").value = "";
    document.getElementById("spendPoints").value = "";

    renderSpendActions();
    renderCalcTables();
  });

  document.getElementById("addInviteRuleForm").addEventListener("submit", e => {
    e.preventDefault();
    const cond = document.getElementById("inviteCondition").value.trim();
    const minVal = Number(document.getElementById("inviteMin").value);
    const maxVal = Number(document.getElementById("inviteMax").value);
    const ptsVal = Number(document.getElementById("invitePoints").value);

    if (!cond) { alert("è¢«é‚€è¯·äººæ¡ä»¶ä¸èƒ½ä¸ºç©ºã€‚"); return; }
    if (![minVal, maxVal, ptsVal].every(n => Number.isFinite(n) && n >= 0)) {
      alert("äººæ•°ä¸ç§¯åˆ†å¿…é¡»ä¸ºéè´Ÿæ•°å­—ã€‚"); return;
    }
    if (maxVal < minVal) { alert("ç»“æŸäººæ•°ä¸èƒ½å°äºèµ·å§‹äººæ•°ã€‚"); return; }

    inviteRules.push({ id: nextId++, condition: cond, min: minVal, max: maxVal, points: ptsVal });

    document.getElementById("inviteMin").value = "";
    document.getElementById("inviteMax").value = "";
    document.getElementById("invitePoints").value = "";

    renderInviteRules();
    renderCalcTables();
    renderScenarioPanel();
  });

  document.getElementById("calcButton").addEventListener("click", calculatePoints);
  document.getElementById("resetCountsButton").addEventListener("click", resetAllCounts);

  document.getElementById("saveConfigButton").addEventListener("click", saveConfig);
  document.getElementById("loadConfigButton").addEventListener("click", () => loadConfig(true));
  document.getElementById("clearConfigButton").addEventListener("click", clearConfig);
  document.getElementById("exportXlsxButton").addEventListener("click", exportConfigToXlsx);

  document.getElementById("importXlsxButton").addEventListener("click", () => {
    const input = document.getElementById("xlsxFileInput");
    input.value = "";
    input.click();
  });
  document.getElementById("xlsxFileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (file) importConfigFromXlsx(file);
  });

  allOneTimeDoneSwitch.addEventListener("change", () => renderCalcTables());

  // âœ… é¢„æµ‹è¡¨æ¨¡å—äº‹ä»¶
  scenarioAddCondBtn.addEventListener("click", addScenarioCondRow);
  scenarioGenBtn.addEventListener("click", generateScenarioTable);
  scenarioCopyBtn.addEventListener("click", copyScenarioTable);
  scenarioExportBtn.addEventListener("click", exportScenarioTableToXlsx);

  // ===== åˆå§‹åŒ– =====
  function initExamples() {
    earnActions = [
      { id: nextId++, name: "å®Œæˆæ–°æ‰‹ä»»åŠ¡", points: 100, oneTime: true },
      { id: nextId++, name: "æ¯æ—¥ç­¾åˆ°", points: 10, oneTime: false },
      { id: nextId++, name: "å®Œæˆä¸€æ¬¡è®¢å•", points: 5, oneTime: false }
    ];
    spendActions = [
      { id: nextId++, name: "å…‘æ¢1å¤©ä¼šå‘˜", points: 20 },
      { id: nextId++, name: "å…‘æ¢3å¤©ä¼šå‘˜", points: 50 },
      { id: nextId++, name: "å…‘æ¢1å‘¨ä¼šå‘˜", points: 120 },
      { id: nextId++, name: "å…‘æ¢1ä¸ªæœˆä¼šå‘˜", points: 400 },
      { id: nextId++, name: "å…‘æ¢3ä¸ªæœˆä¼šå‘˜", points: 1100 },
      { id: nextId++, name: "å…‘æ¢6ä¸ªæœˆä¼šå‘˜", points: 2000 },
      { id: nextId++, name: "å…‘æ¢1å¹´ä¼šå‘˜", points: 3600 }
    ];
    inviteRules = [
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 0, max: 1, points: 10 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸ", min: 2, max: 5, points: 20 },
      { id: nextId++, condition: "è¢«é‚€è¯·äººå®Œæˆé¦–å•", min: 0, max: 2, points: 30 }
    ];

    renderEarnActions();
    renderSpendActions();
    renderInviteRules();

    allOneTimeDoneSwitch.checked = false;
    renderCalcTables();

    // é¢„æµ‹è¡¨æ¨¡å—
    scenarioCondRowIds = [];
    scenarioCondNextId = 1;
    renderScenarioPanel();
  }

  function init() {
    const loaded = loadConfig(false);
    if (!loaded) initExamples();
    else renderScenarioPanel();
  }

  init();
</script>
</body>
</html>
